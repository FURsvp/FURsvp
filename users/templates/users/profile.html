{% extends 'events/base.html' %}
{% load users_extras %}
{% load widget_tweaks %}
{% block title %}Profile - FURsvp{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <div class="modern-breadcrumbs">
        <a href="/" class="d-flex align-items-center">
            <i class="material-icons me-1">home</i> Home
        </a>
        <span class="breadcrumb-chevron">â€º</span>
        <span class="breadcrumb-current">Profile</span>
    </div>
</nav>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm mb-4 profile-glass-card">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            {% if profile.profile_picture_base64 %}
                            <img src="{{ profile.profile_picture_base64 }}" alt="{{ profile.get_display_name }}"
                                class="profile-avatar">
                            {% else %}
                            <div class="rounded-circle d-flex align-items-center justify-content-center avatar-initials-placeholder"
                                style="background-color: {{ profile.get_avatar_color }};">
                                {{ profile.get_initials }}
                            </div>
                            {% endif %}
                            <button type="button" class="profile-edit-btn" data-bs-toggle="modal"
                                data-bs-target="#profilePictureModal">
                                <i class="material-icons" style="font-size: 20px; line-height: 1;">edit</i>
                            </button>
                        </div>
                        <h2 class="mt-3">{{ profile.get_display_name }}</h2>
                        <p class="text-muted">@{{ user.username }}</p>
                    </div>

                    <ul class="nav nav-tabs mb-4 profile-tabs" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab"
                                data-bs-target="#general" type="button" role="tab" aria-controls="general"
                                aria-selected="true">
                                <i class="material-icons align-middle me-1">settings</i> General Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password"
                                type="button" role="tab" aria-controls="password" aria-selected="false">
                                <i class="material-icons align-middle me-1">lock</i> Change Password
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="delete-tab" data-bs-toggle="tab" data-bs-target="#delete"
                                type="button" role="tab" aria-controls="delete" aria-selected="false">
                                <i class="material-icons align-middle me-1 text-danger">delete_forever</i> Delete
                                Account
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="profileTabsContent">
                        <div class="tab-pane fade show active" id="general" role="tabpanel"
                            aria-labelledby="general-tab">
                            <form method="post" class="mb-4 profile-form" id="main-profile-form"
                                action="{% url 'profile' %}">
                                {% csrf_token %}
                                <input type="hidden" name="submit_profile_changes" value="1">

                                <div class="mb-3">
                                    <label for="{{ profile_form.display_name.id_for_label }}"
                                        class="form-label profile-form-label">
                                        <i class="material-icons align-middle me-1">badge</i>
                                        Display Name
                                    </label>
                                    {{ profile_form.display_name }}
                                    {% if profile_form.display_name.help_text %}
                                    <div class="form-text">{{ profile_form.display_name.help_text }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ profile_form.email.id_for_label }}"
                                        class="form-label profile-form-label">
                                        <i class="material-icons align-middle me-1">email</i>
                                        Email Address
                                    </label>
                                    {{ profile_form.email }}
                                    {% if profile_form.email.help_text %}
                                    <div class="form-text">{{ profile_form.email.help_text }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ profile_form.discord_username.id_for_label }}"
                                        class="form-label profile-form-label">
                                        <i class="material-icons align-middle me-1">chat</i>
                                        Discord Username
                                    </label>
                                    {{ profile_form.discord_username }}
                                    {% if profile_form.discord_username.help_text %}
                                    <div class="form-text">{{ profile_form.discord_username.help_text }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ profile_form.telegram_username.id_for_label }}"
                                        class="form-label profile-form-label">
                                        <i class="material-icons align-middle me-1">send</i>
                                        Telegram Username
                                    </label>
                                    {{ profile_form.telegram_username }}
                                    {% if profile_form.telegram_username.help_text %}
                                    <div class="form-text">{{ profile_form.telegram_username.help_text }}</div>
                                    {% endif %}
                                </div>
                                {% if telegram_login_enabled and user.profile.telegram_username%}
                                <!-- Telegram Account Linking Section -->
                                <div class="mb-4">
                                    <div class="card border-0 shadow-sm"
                                        style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                                        <div class="card-body p-4">
                                            <h6 class="card-title d-flex align-items-center mb-3"
                                                style="color: #229ED9; font-weight: 700;">
                                                <i class="material-icons me-2">send</i>
                                                Telegram Account (OAuth)
                                            </h6>

                                            {% if user.profile.telegram_id and user.profile.telegram_username %}
                                            <!-- Account is linked -->
                                            <div class="d-flex align-items-center justify-content-between">
                                                <div>
                                                    <p class="mb-1 fw-semibold" style="color: #1e40af;">
                                                        <i class="material-icons align-middle me-1"
                                                            style="font-size: 1.1rem; color: #229ED9;">check_circle</i>
                                                        Account Linked
                                                    </p>
                                                    <p class="mb-0 text-muted small">
                                                        Telegram ID: {{ user.profile.telegram_id }}
                                                        {% if user.profile.telegram_username %}
                                                        <br>Username: @{{ user.profile.telegram_username }}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                <button type="button" class="btn btn-outline-danger btn-sm"
                                                    id="unlink-telegram-btn">
                                                    <i class="material-icons me-1">link_off</i>
                                                    Unlink
                                                </button>
                                            </div>
                                            {% else %}
                                            <!-- Account is not linked -->
                                            <div class="text-center">
                                                <p class="mb-3 text-muted">
                                                    <i class="material-icons align-middle me-1"
                                                        style="color: #6b7280;">link_off</i>
                                                    No Telegram account linked
                                                </p>
                                                <div id="telegram-login-widget"></div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                {{ profile_form.profile_picture_base64 }}

                                <div class="d-grid">
                                    <button type="button" class="profile-save-btn" id="main-profile-save-button">
                                        <i class="material-icons">save</i> Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="password-tab">
                            <div class="card-body">
                                <form method="post" action="{% url 'profile' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="submit_password_changes" value="1">
                                    {% for field in password_change_form %}
                                    <div class="mb-3">
                                        <label for="{{ field.id_for_label }}" class="profile-password-label">
                                            <i class="material-icons align-middle me-1">lock</i>
                                            {{ field.label }}
                                        </label>
                                        {{ field|add_class:'profile-password-input' }}
                                        {% if field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                        {% endif %}
                                        {% if field.errors %}
                                        <div class="invalid-feedback d-block">{{ field.errors }}</div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    <div class="d-grid">
                                        <button type="submit" class="profile-password-btn">
                                            <i class="material-icons">save</i> Change Password
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="delete" role="tabpanel" aria-labelledby="delete-tab">
                            <div class="card shadow-sm mb-4 profile-delete-section">
                                <div class="card-body">
                                    <h2 class="h4 mb-4 text-danger">
                                        <i class="material-icons align-middle me-2">delete_forever</i>
                                        Delete Account
                                    </h2>
                                    <p>
                                        <strong>Warning:</strong> Deleting your account is permanent and cannot be
                                        undone. All your data will be lost.
                                    </p>
                                    <div class="mt-4">
                                        <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal"
                                            data-bs-target="#deleteAccountModal">
                                            <i class="material-icons me-2">delete_forever</i> Delete My Account
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Picture Modal -->
<div class="modal fade" id="profilePictureModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="material-icons">photo_camera</i> Update Profile Picture
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="profile-picture-form">
                    {% csrf_token %}
                    <input type="hidden" name="profile_picture_base64" id="profile-picture-base64">
                    <input type="hidden" name="submit_pfp_changes" value="1">
                    <div class="mb-3">
                        <label for="profile-picture-input" class="form-label">Choose an image</label>
                        <input type="file" class="form-control" id="profile-picture-input" accept="image/*">
                    </div>
                    <div class="mb-3 d-none" id="image-cropper-container">
                        <img id="image-to-crop" src="" alt="Image to Crop" style="max-width: 100%; display: block;">
                    </div>

                    <!-- Remove Profile Picture Button -->
                    {% if profile.profile_picture_base64 %}
                    <div class="mb-3" id="remove-pfp-button-container">
                        <button type="button" class="btn btn-outline-danger w-100" id="remove-pfp-button">
                            <i class="material-icons me-2">delete</i> Remove Current Profile Picture
                        </button>
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="crop-and-save-button">Crop and Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Math Equation Modal (Step 1) -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content profile-glass-card p-3"
            style="box-shadow: 0 8px 32px rgba(239,68,68,0.18); border: 2px solid #fca5a5;">
            <form id="delete-account-form" onsubmit="return false;">
                {% csrf_token %}
                <input type="hidden" name="delete_account" value="1">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-danger d-flex align-items-center gap-2"
                        id="deleteAccountModalLabel">
                        <i class="material-icons text-danger" style="font-size: 2rem;">warning</i>
                        You're logging out fur-ever?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-2 pb-0">
                    <p class="mb-2">Don't forget to boop snoots on your way out! ðŸ¥²</p>
                    <div class="alert alert-danger mb-3" style="background: #fef2f2; color: #b91c1c; border: none;">
                        <strong>This action cannot be undone.</strong> To confirm, please solve the following equation:
                    </div>
                    <div class="mb-3">
                        <span id="math-equation" class="fw-bold fs-5"></span>
                        <input type="number" class="form-control mt-2" id="math-answer" placeholder="Your answer"
                            required
                            style="background: #f8fafc; border-radius: 1em; border: 1.5px solid #fca5a5; font-size: 1.15rem;">
                        <div class="invalid-feedback" id="math-feedback">Incorrect answer. Please try again.</div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="profile-save-btn"
                        style="background: linear-gradient(90deg, #ef4444 0%, #fca5a5 100%); color: #fff; font-weight: 800; font-size: 1.15rem;"
                        id="open-final-delete-btn" disabled>
                        <i class="material-icons me-2">delete_forever</i> Delete My Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Final Confirmation Modal (Step 2) -->
<div class="modal fade" id="finalDeleteModal" tabindex="-1" aria-labelledby="finalDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content profile-glass-card p-3"
            style="box-shadow: 0 8px 32px rgba(239,68,68,0.18); border: 2px solid #fca5a5;">
            <form method="post" id="final-delete-form">
                {% csrf_token %}
                <input type="hidden" name="delete_account" value="1">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-danger d-flex align-items-center gap-2"
                        id="finalDeleteModalLabel">
                        <i class="material-icons text-danger" style="font-size: 2rem;">delete_forever</i>
                        Last chance! Really delete your account?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-2 pb-0">
                    <div class="alert alert-danger mb-3" style="background: #fef2f2; color: #b91c1c; border: none;">
                        <strong>This is your last chance to back out.</strong> If you proceed, your account will be
                        deleted forever.
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">I want my
                        mommy...</button>
                    <button type="submit" class="profile-save-btn"
                        style="background: linear-gradient(90deg, #ef4444 0%, #fca5a5 100%); color: #fff; font-weight: 800; font-size: 1.15rem;"
                        id="final-delete-btn">
                        <i class="material-icons me-2">delete_forever</i> Delete for real
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="telegram-redirect-feedback" style="display:none;text-align:center;margin:2em 0;">
  <div class="spinner-border text-info" role="status" style="width:3rem;height:3rem;">
    <span class="visually-hidden">Loading...</span>
  </div>
  <div style="margin-top:1em;font-weight:bold;">Linking your Telegram account, please wait...</div>
</div>
<noscript>
  <div class="alert alert-warning text-center mt-3">JavaScript is required for Telegram login to work.</div>
</noscript>
<script>
  // Show feedback if redirected from Telegram
  if (window.location.search.includes('auth_date') && window.location.pathname.includes('link')) {
    var feedback = document.getElementById('telegram-redirect-feedback');
    if (feedback) feedback.style.display = 'block';
  }
</script>

<style>
    .avatar-initials-placeholder {
        width: 150px;
        height: 150px;
        color: white;
        font-size: 3rem;
        font-weight: bold;
    }

    .profile-glass-card {
        background: rgba(255, 255, 255, 0.88);
        border-radius: 1.5rem;
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.13);
        backdrop-filter: blur(6px);
        padding: 2.5rem 2.2rem 2.2rem 2.2rem;
        margin-bottom: 2.5rem;
        border: 1.5px solid #e0e7ef;
    }

    .profile-glass-card {
        background: rgba(255, 255, 255, 0.88);
        border-radius: 1.5rem;
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.13);
        backdrop-filter: blur(6px);
        padding: 2.5rem 2.2rem 2.2rem 2.2rem;
        margin-bottom: 2.5rem;
        border: 1.5px solid #e0e7ef;
    }

    .profile-avatar {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
        box-shadow: 0 4px 24px rgba(59, 130, 246, 0.13);
        border: 4px solid #fff;
        background: #f8fafc;
    }

    .profile-edit-btn {
        background: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
        color: #fff;
        border: none;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.10);
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        position: absolute;
        bottom: -10px;
        right: -10px;
        transition: background 0.18s, box-shadow 0.18s, transform 0.13s;
    }

    .profile-edit-btn:hover {
        background: linear-gradient(135deg, #1a2f9a 0%, #0e7490 100%);
        color: #fff;
        box-shadow: 0 4px 18px rgba(59, 130, 246, 0.18);
        transform: scale(1.07);
    }

    .profile-tabs {
        border-bottom: none !important;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        background: transparent;
    }

    .profile-tabs .nav-link {
        border: none !important;
        border-radius: 2em !important;
        background: #f4f8ff;
        color: #223b7b;
        font-weight: 700;
        font-size: 1.13rem;
        padding: 0.8em 2.2em;
        margin: 0 0.1em;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.07);
        transition:
            background 0.18s,
            color 0.18s,
            box-shadow 0.18s,
            transform 0.13s;
        position: relative;
        z-index: 1;
        outline: none;
    }

    .profile-tabs .nav-link.active,
    .profile-tabs .nav-link:focus,
    .profile-tabs .nav-link:hover {
        background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%);
        color: #fff !important;
        box-shadow: 0 6px 24px rgba(59, 130, 246, 0.18);
        transform: translateY(-3px) scale(1.06);
        font-weight: 800;
    }

    .profile-tabs .nav-link:not(.active):hover {
        background: #e0f0ff;
        color: #2563eb;
        box-shadow: 0 2px 12px rgba(59, 130, 246, 0.13);
        transform: translateY(-1px) scale(1.03);
        font-weight: 700;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.13s;
    }

    .profile-tabs .nav-link .material-icons {
        vertical-align: middle;
        margin-right: 0.3em;
        font-size: 1.2em;
    }

    .profile-form-label {
        font-weight: 700;
        color: #223b7b;
        margin-bottom: 0.4rem;
    }

    .profile-form .form-control {
        background: #f8fafc;
        border-radius: 0.7rem;
        border: 1.5px solid #e0e7ef;
        font-size: 1.13rem;
        font-weight: 500;
        color: #223b7b;
        transition: box-shadow 0.18s, border-color 0.18s;
    }

    .profile-form .form-control:focus {
        box-shadow: 0 0 0 2px #b3d1f7;
        border-color: #2563eb;
        background: #fff;
    }

    .profile-save-btn {
        width: 100%;
        background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%);
        color: #fff !important;
        font-weight: 800;
        border: none;
        border-radius: 2em;
        box-shadow: 0 2px 12px rgba(59, 130, 246, 0.10);
        padding: 0.9em 0;
        font-size: 1.18rem;
        transition: background 0.18s, box-shadow 0.18s, transform 0.13s;
        margin-top: 0.2rem;
        margin-bottom: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.7em;
    }

    .profile-save-btn:hover,
    .profile-save-btn:focus {
        background: linear-gradient(90deg, #1a2f9a 0%, #0e7490 100%);
        color: #fff !important;
        box-shadow: 0 4px 18px rgba(59, 130, 246, 0.18);
        transform: scale(1.03);
    }

    .profile-delete-section .card {
        border: 2px solid #ffe0e0;
        background: linear-gradient(90deg, #fff0f0 0%, #ffe0e0 100%);
        border-radius: 1.1rem;
        box-shadow: 0 2px 12px rgba(220, 53, 69, 0.07);
    }

    .profile-delete-section .btn-danger {
        background: linear-gradient(90deg, #dc3545 0%, #ff6f6f 100%);
        border: none;
        border-radius: 2em;
        font-weight: 700;
        font-size: 1.08rem;
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.10);
        transition: background 0.18s, box-shadow 0.18s, transform 0.13s;
    }

    .profile-delete-section .btn-danger:hover,
    .profile-delete-section .btn-danger:focus {
        background: linear-gradient(90deg, #b91c1c 0%, #dc2626 100%);
        color: #fff;
        box-shadow: 0 4px 18px rgba(220, 53, 69, 0.18);
        transform: scale(1.03);
    }

    @media (max-width: 600px) {
        .profile-glass-card {
            padding: 1.2rem 0.5rem 1.2rem 0.5rem;
        }

        .profile-tabs {
            flex-direction: column;
            gap: 0.3rem;
        }

        .profile-tabs .nav-link {
            font-size: 1rem;
            padding: 0.7em 0.7em;
        }

        .profile-avatar {
            width: 90px;
            height: 90px;
        }
    }

    .profile-password-card {
        background: #f8fafc;
        border-radius: 1.25rem;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        padding: 2.5rem 2.5rem 2rem 2.5rem;
        margin-bottom: 2.5rem;
        border: 1.5px solid #e0e7ef;
    }

    .profile-password-label {
        font-weight: 700;
        color: #223b7b;
        margin-bottom: 0.4rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.1rem;
    }

    .profile-password-input {
        width: 100%;
        border-radius: 0.7rem;
        border: 1.5px solid #e0e7ef;
        background: #fff;
        font-size: 1.13rem;
        font-weight: 500;
        color: #223b7b;
        padding: 0.85rem 1.1rem;
        margin-bottom: 0.5rem;
        transition: box-shadow 0.18s, border-color 0.18s;
    }

    .profile-password-input:focus {
        box-shadow: 0 0 0 2px #b3d1f7;
        border-color: #2563eb;
        background: #fff;
    }

    .profile-password-btn {
        width: 100%;
        background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%);
        color: #fff !important;
        font-weight: 800;
        border: none;
        border-radius: 2em;
        box-shadow: 0 2px 12px rgba(59, 130, 246, 0.10);
        padding: 1em 0;
        font-size: 1.18rem;
        transition: background 0.18s, box-shadow 0.18s, transform 0.13s;
        margin-top: 0.2rem;
        margin-bottom: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.7em;
    }

    .profile-password-btn:hover,
    .profile-password-btn:focus {
        background: linear-gradient(90deg, #1a2f9a 0%, #0e7490 100%);
        color: #fff !important;
        box-shadow: 0 4px 18px rgba(59, 130, 246, 0.18);
        transform: scale(1.03);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const profilePictureInput = document.getElementById('profile-picture-input');
        const imageToCrop = document.getElementById('image-to-crop');
        const imageCropperContainer = document.getElementById('image-cropper-container');
        const profilePictureBase64Input = document.getElementById('profile-picture-base64');
        const cropAndSaveButton = document.getElementById('crop-and-save-button');
        const removePfpButtonContainer = document.getElementById('remove-pfp-button-container');
        const removePfpButton = document.getElementById('remove-pfp-button');
        let cropper;

        // Show/hide remove button based on if a profile picture exists
        if (removePfpButtonContainer && profilePictureBase64Input.value) {
            removePfpButtonContainer.style.display = 'block';
        }

        profilePictureInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    imageToCrop.src = event.target.result;
                    if (cropper) {
                        cropper.destroy();
                    }
                    imageCropperContainer.classList.remove('d-none');
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1 / 1,
                        viewMode: 1,
                        autoCropArea: 0.8,
                        responsive: true,
                        dragMode: 'move',
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false
                    });
                    // Hide remove button when a new image is selected for upload
                    if (removePfpButtonContainer) {
                        removePfpButtonContainer.style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            } else {
                // If no file selected (e.g., cleared input), hide cropper and show remove button if pfp exists
                if (cropper) {
                    cropper.destroy();
                }
                imageCropperContainer.classList.add('d-none');
                if (removePfpButtonContainer && profilePictureBase64Input.value) {
                    removePfpButtonContainer.style.display = 'block';
                }
            }
        });

        cropAndSaveButton.addEventListener('click', function () {
            if (cropper) {
                const croppedCanvas = cropper.getCroppedCanvas({
                    width: 150, // Target width for the profile picture
                    height: 150 // Target height for the profile picture
                });
                profilePictureBase64Input.value = croppedCanvas.toDataURL('image/jpeg');
                document.getElementById('profile-picture-form').submit();
            }
        });

        if (removePfpButton) {
            removePfpButton.addEventListener('click', function () {
                if (confirm('Are you sure you want to remove your profile picture?')) {
                    profilePictureBase64Input.value = ''; // Clear the base64 value
                    document.getElementById('profile-picture-form').submit();
                }
            });
        }

        // Handle main profile form submission
        const mainProfileSaveButton = document.getElementById('main-profile-save-button');
        const mainProfileForm = document.getElementById('main-profile-form');

        if (mainProfileSaveButton && mainProfileForm) {
            mainProfileSaveButton.addEventListener('click', function () {
                console.log("Attempting to submit main profile form..."); // New debug log
                mainProfileForm.submit();
            });
        }

        // Handle unban from group buttons
        document.querySelectorAll('.unban-from-group-btn').forEach(button => {
            button.addEventListener('click', async function () {
                const userId = this.dataset.userId;
                const groupId = this.dataset.groupId;

                if (!confirm('Are you sure you want to unban this user from this group?')) {
                    return;
                }

                const formData = new FormData();
                formData.append('user_id', userId);
                formData.append('group_id', groupId);
                formData.append('action', 'unban');
                formData.append('ban_type', 'group'); // Specify ban type as 'group'

                try {
                    const url = `/users/${userId}/ban/`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(data.message);
                        location.reload(); // Reload the page to reflect changes
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while processing your request.');
                }
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Restore last active profile tab
        const profileTabs = document.getElementById('profileTabs');
        if (profileTabs) {
            const lastProfileTab = localStorage.getItem('lastProfileTab');
            if (lastProfileTab) {
                const lastTabButton = document.querySelector(
                    `#profileTabs button[data-bs-target="${lastProfileTab}"]`);
                if (lastTabButton) {
                    new bootstrap.Tab(lastTabButton).show();
                }
            }

            // Save tab on click
            profileTabs.querySelectorAll('button[data-bs-toggle="tab"]').forEach(function (tabBtn) {
                tabBtn.addEventListener('shown.bs.tab', function (e) {
                    localStorage.setItem('lastProfileTab', e.target.getAttribute(
                        'data-bs-target'));
                });
            });
        }
    });

    // Math equation logic for delete modal
    function generateEquation() {
        const a = Math.floor(Math.random() * 10) + 1;
        const b = Math.floor(Math.random() * 10) + 1;
        const op = Math.random() > 0.5 ? '+' : '-';
        const answer = op === '+' ? a + b : a - b;
        return {
            text: `${a} ${op} ${b} = ?`,
            answer
        };
    }
    let equation = null;
    document.addEventListener('DOMContentLoaded', function () {
        var deleteModal = document.getElementById('deleteAccountModal');
        var equationSpan = document.getElementById('math-equation');
        var answerInput = document.getElementById('math-answer');
        var openFinalBtn = document.getElementById('open-final-delete-btn');
        var feedback = document.getElementById('math-feedback');
        var finalDeleteModal = document.getElementById('finalDeleteModal');
        var finalDeleteForm = document.getElementById('final-delete-form');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', function () {
                equation = generateEquation();
                equationSpan.textContent = equation.text;
                answerInput.value = '';
                openFinalBtn.disabled = true;
                feedback.style.display = 'none';
            });
            answerInput.addEventListener('input', function () {
                if (parseInt(answerInput.value, 10) === equation.answer) {
                    openFinalBtn.disabled = false;
                    feedback.style.display = 'none';
                } else {
                    openFinalBtn.disabled = true;
                    if (answerInput.value !== '') {
                        feedback.style.display = 'block';
                    } else {
                        feedback.style.display = 'none';
                    }
                }
            });
            openFinalBtn.addEventListener('click', function () {
                var bsModal = bootstrap.Modal.getInstance(deleteModal);
                bsModal.hide();
                var finalModal = new bootstrap.Modal(finalDeleteModal);
                finalModal.show();
            });
        }
    });
</script>

{% if telegram_login_enabled %}
<script src="https://telegram.org/js/telegram-widget.js?22"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Telegram Login Widget for profile linking
    const telegramWidget = document.getElementById('telegram-login-widget');
    if (telegramWidget && typeof Telegram !== 'undefined') {
        Telegram.Login.Widget({
            dataOnauth: function(user) {
                // Redirect to link_telegram_account with user data
                const params = new URLSearchParams(user);
                window.location.href = '{% url "link_telegram_account" %}?' + params.toString();
            },
            bot_id: '{{ telegram_bot_username }}',
            request_access: true,
            lang: 'en'
        }, telegramWidget);
    }
    
    // Handle unlink Telegram button
    const unlinkTelegramBtn = document.getElementById('unlink-telegram-btn');
    if (unlinkTelegramBtn) {
        unlinkTelegramBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to unlink your Telegram account?')) {
                fetch('{% url "unlink_telegram_account" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while unlinking your account.');
                });
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% endblock %}