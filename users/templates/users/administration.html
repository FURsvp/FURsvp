{% extends 'events/base.html' %}
{% load users_extras %}
{% load widget_tweaks %}
{% block title %}Administration - FURsvp{% endblock %}

{% block extra_css %}
<style>
/* Admin Panel Styles */
.admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 0;
}

.admin-header {
    text-align: center;
    margin-bottom: 3rem;
}

.admin-header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    color: #1e293b;
    margin-bottom: 0.5rem;
}

.admin-header p {
    color: #64748b;
    font-size: 1.1rem;
}

/* Navigation Tabs */
.admin-nav {
    background: white;
    border-radius: 1rem;
    padding: 0.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.admin-nav .nav-link {
    border: none;
    border-radius: 0.75rem;
    padding: 1rem 1.5rem;
    font-weight: 600;
    color: #64748b;
    transition: all 0.3s ease;
    margin: 0 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.admin-nav .nav-link:hover {
    background: #f1f5f9;
    color: #334155;
    transform: translateY(-1px);
}

.admin-nav .nav-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

/* Content Cards */
.admin-card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.admin-card-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e2e8f0;
}

.admin-card-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.admin-card-body {
    padding: 2rem;
}

/* Search Bar */
.search-container {
    background: #f8fafc;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid #e2e8f0;
}

.search-form {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.search-input {
    flex: 1;
    border: 2px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 0.875rem 1.25rem;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 0.75rem;
    padding: 0.875rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.search-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

/* User Table */
.user-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.user-table th {
    background: #f8fafc;
    padding: 1rem 1.5rem;
    text-align: left;
    font-weight: 700;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.user-table td {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: middle;
}

.user-table tbody tr:hover {
    background: #f8fafc;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.125rem;
}

.user-details h4 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
}

.user-details p {
    margin: 0;
    color: #6b7280;
    font-size: 0.875rem;
    line-height: 1.4;
}

.user-details p strong,
.user-details p b {
    font-weight: 600;
    color: #374151;
}

.user-details p em,
.user-details p i {
    font-style: italic;
}

.user-details p a {
    color: #667eea;
    text-decoration: none;
}

.user-details p a:hover {
    text-decoration: underline;
}

.user-details p code {
    background: #f3f4f6;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
}

.group-meta {
    margin-top: 0.5rem;
}

.group-meta small {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    line-height: 1.2;
}

.group-meta small a {
    color: #667eea;
    text-decoration: none;
}

.group-meta small a:hover {
    text-decoration: underline;
}

.group-meta .material-icons {
    opacity: 0.7;
}

.admin-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.admin-badge.yes {
    background: #dcfce7;
    color: #166534;
}

.admin-badge.no {
    background: #fef2f2;
    color: #dc2626;
}

/* Tom Select Customization */
.tom-select-custom .ts-wrapper {
    border: 2px solid #e2e8f0;
    border-radius: 0.75rem;
    transition: all 0.3s ease;
    position: relative;
    z-index: 100;
    background: white;
}

.tom-select-custom .ts-wrapper.focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    z-index: 200;
}

.tom-select-custom .ts-control {
    border: none;
    background: transparent;
    padding: 0.75rem 1rem;
    min-height: 44px;
    position: relative;
    z-index: 100;
    font-size: 0.875rem;
    color: #374151;
}

.tom-select-custom .ts-dropdown {
    border: 2px solid #667eea;
    border-radius: 1rem;
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.15);
    background: white;
    position: absolute !important;
    z-index: 99999 !important;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 8px;
    padding: 0.5rem 0;
}

.tom-select-custom .ts-dropdown .option {
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.3s ease;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin: 0 0.5rem;
    border-radius: 0.5rem;
}

.tom-select-custom .ts-dropdown .option:hover {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.tom-select-custom .ts-dropdown .option.selected {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.tom-select-custom .ts-dropdown .option.selected:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
}

/* Selected Items - Admin Badge Theme */
.tom-select-custom .ts-wrapper .item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    margin: 0.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    border: none;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    transition: all 0.2s ease;
    max-width: 200px;
    overflow: hidden;
}

.tom-select-custom .ts-wrapper .item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.tom-select-custom .ts-wrapper .item .remove {
    color: rgba(255, 255, 255, 0.8);
    font-weight: bold;
    margin-left: 0.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    line-height: 1;
    padding: 2px;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tom-select-custom .ts-wrapper .item .remove:hover {
    color: white;
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

.tom-select-custom .ts-wrapper .item .group-logo {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.3);
    flex-shrink: 0;
}

.tom-select-custom .ts-wrapper .item .group-logo-placeholder {
    width: 16px;
    height: 16px;
    font-size: 8px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    font-weight: 700;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.2px;
}

/* Dropdown option logos */
.tom-select-custom .ts-dropdown .option .group-logo {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e2e8f0;
    flex-shrink: 0;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    position: relative;
    left: 0;
}

.tom-select-custom .ts-dropdown .option .group-logo-placeholder {
    width: 28px;
    height: 28px;
    font-size: 12px;
    border: 2px solid #e2e8f0;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    color: white;
    font-weight: 700;
    box-shadow: 0 3px 6px rgba(102, 126, 234, 0.3);
    position: relative;
    left: 0;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.5px;
}

/* Input placeholder styling */
.tom-select-custom .ts-control .item + input {
    color: #64748b;
    font-size: 0.875rem;
}

/* No options message */
.tom-select-custom .ts-dropdown .no-results {
    padding: 1rem;
    text-align: center;
    color: #64748b;
    font-style: italic;
}

/* Ensure table doesn't clip the dropdown */
.table-responsive {
    overflow: visible !important;
}

.user-table {
    position: relative;
}

.user-table td {
    position: relative;
    overflow: visible;
}

/* Ensure Tom Select wrapper has proper positioning */
.tom-select-custom .ts-wrapper {
    position: relative !important;
    z-index: 100;
}

.tom-select-custom .ts-wrapper.focus {
    z-index: 99998 !important;
}

.tom-select-custom .ts-dropdown .option {
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s ease;
}

.tom-select-custom .ts-dropdown .option:hover {
    background-color: #f8fafc;
}

.tom-select-custom .ts-dropdown .option.selected {
    background-color: #667eea;
    color: white;
}

.group-logo {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e2e8f0;
    flex-shrink: 0;
}

.group-logo-placeholder {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #667eea;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
    font-weight: 600;
    border: 2px solid #e2e8f0;
    flex-shrink: 0;
}

.ts-wrapper .item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #667eea;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    margin: 0.125rem;
    font-size: 0.75rem;
}

.ts-wrapper .item .group-logo {
    width: 32px;
    height: 32px;
    border-color: rgba(255, 255, 255, 0.3);
}

.ts-wrapper .item .group-logo-placeholder {
    width: 32px;
    height: 32px;
    font-size: 8px;
    border-color: rgba(255, 255, 255, 0.3);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    justify-content: flex-end;
}

/* Individual Action Button Styling */
.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 38px;
    height: 38px;
    padding: 0;
    border-radius: 8px;
    transition: all 0.2s ease;
    border: 2px solid;
    flex-shrink: 0;
    box-sizing: border-box;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.action-btn.btn-outline-primary {
    border-color: #3b82f6;
    color: #3b82f6;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
}

.action-btn.btn-outline-primary:hover {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-color: #3b82f6;
    color: white;
}

.action-btn.btn-outline-danger {
    border-color: #ef4444;
    color: #ef4444;
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.action-btn.btn-outline-danger:hover {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border-color: #ef4444;
    color: white;
}

.action-btn .material-icons {
    font-size: 18px;
    line-height: 1;
}

/* Ensure consistent button heights in forms */
.d-flex.gap-2 .action-btn {
    min-height: 36px;
    max-height: 36px;
}

.btn-primary-admin {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 0.75rem;
    padding: 0.875rem 2rem;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary-admin:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    color: white;
}

/* Pagination */
.pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 2rem;
}

.pagination .page-link {
    border: none;
    padding: 0.75rem 1rem;
    margin: 0 0.25rem;
    border-radius: 0.5rem;
    color: #667eea;
    font-weight: 600;
    transition: all 0.3s ease;
}

.pagination .page-link:hover {
    background: #f1f5f9;
    transform: translateY(-1px);
}

.pagination .page-item.active .page-link {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

/* Modal Z-Index Override */
.modal {
    z-index: 9999 !important;
}

.modal-backdrop {
    z-index: 9998 !important;
}

/* Ensure buttons are visible above table elements */
.btn {
    position: relative;
    z-index: 10;
}

.user-table td {
    position: relative;
}

.user-table td .btn {
    z-index: 20;
}

/* User Selection Styles */
.user-selection-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.user-selection-item:hover {
    background: #f8fafc;
    border-color: #667eea;
}

.user-selection-item.selected {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.user-selection-item.selected:hover {
    background: #5a67d8;
}

.user-selection-checkbox {
    margin: 0;
}

.user-selection-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    flex-shrink: 0;
}

.user-selection-details h6 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 600;
}

.user-selection-details small {
    color: inherit;
    opacity: 0.8;
}

/* Responsive */
@media (max-width: 768px) {
    .admin-container {
        padding: 1rem;
    }
    
    .search-form {
        flex-direction: column;
    }
    
    .user-table {
        font-size: 0.875rem;
    }
    
    .user-table th,
    .user-table td {
        padding: 0.75rem;
    }
}

/* Force dropdown to appear above everything */
.ts-dropdown,
.tom-select-custom .ts-dropdown {
    z-index: 999999 !important;
    position: absolute !important;
}

/* Lower z-index for buttons to prevent conflicts */
.btn, .action-btn, .btn-primary-admin {
    z-index: 1 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Header -->
    <div class="admin-header">
        <h1>
            <i class="material-icons align-middle me-2">admin_panel_settings</i>
            Administration Panel
            </h1>
        <p>Manage users, groups, and platform settings</p>
    </div>

    <!-- Navigation -->
    <div class="admin-nav">
        <ul class="nav nav-pills justify-content-center" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                <button class="nav-link active" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab">
                    <i class="material-icons">people</i>
                    Users
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                <button class="nav-link" id="groups-tab" data-bs-toggle="pill" data-bs-target="#groups" type="button" role="tab">
                    <i class="material-icons">group_add</i>
                    Groups
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                <button class="nav-link" id="bans-tab" data-bs-toggle="pill" data-bs-target="#bans" type="button" role="tab">
                    <i class="material-icons">gavel</i>
                    Bans
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                <button class="nav-link" id="banner-tab" data-bs-toggle="pill" data-bs-target="#banner" type="button" role="tab">
                    <i class="material-icons">campaign</i>
                    Banner
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                <button class="nav-link" id="notify-tab" data-bs-toggle="pill" data-bs-target="#notify" type="button" role="tab">
                    <i class="material-icons">notifications</i>
                    Notifications
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab" aria-controls="audit" aria-selected="false">
                        <i class="material-icons align-middle me-1">history</i> Audit Log
                    </button>
                </li>
                {% if user.profile.can_post_blog %}
                <li class="nav-item" role="presentation">
                <button class="nav-link" id="blog-tab" data-bs-toggle="pill" data-bs-target="#blog" type="button" role="tab">
                    <i class="material-icons">rss_feed</i>
                    Blog
                    </button>
                </li>
                {% endif %}
            </ul>
    </div>

    <!-- Content -->
            <div class="tab-content" id="adminTabsContent">
        <!-- Users Tab -->
        <div class="tab-pane fade show active" id="users" role="tabpanel">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>
                        <i class="material-icons">people</i>
                        User Management
                    </h2>
                </div>
                <div class="admin-card-body">
                    <!-- Search -->
                    <div class="search-container">
                        <form method="get" class="search-form">
                            <input type="text" 
                                   name="user_search" 
                                   value="{{ user_search }}" 
                                   class="search-input" 
                                   placeholder="Search users by name, username, or email...">
                            <button type="submit" class="search-btn">
                                <i class="material-icons">search</i>
                                Search
                                </button>
                                {% if user_search %}
                            <a href="?{% if request.GET.group_search %}group_search={{ request.GET.group_search }}{% endif %}" 
                               class="btn btn-outline-secondary">
                                <i class="material-icons">clear</i>
                                Clear
                                </a>
                                {% endif %}
                        </form>
                    </div>
                                        <!-- Users Table -->
                    <form method="post" id="userProfileForm">
                        {% csrf_token %}
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h3 class="mb-0">Users</h3>
                                <p class="text-muted mb-0">Manage user permissions and group assignments</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" name="promote_users_submit" class="btn btn-primary-admin">
                                    <i class="material-icons">save</i>
                                    Save Changes
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Admin Status</th>
                                        <th>Groups</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user_obj in users_to_promote %}
                                    <tr>
                                        <td>
                                            <div class="user-info">
                                                <div class="user-avatar">
                                                    {% if user_obj.profile.profile_picture_base64 %}
                                                        <img src="{{ user_obj.profile.profile_picture_base64 }}" 
                                                             alt="{{ user_obj.profile.get_display_name }}"
                                                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                                    {% else %}
                                                        {{ user_obj.profile.get_initials }}
                                                    {% endif %}
                                                </div>
                                                <div class="user-details">
                                                    <h4>{{ user_obj.profile.get_display_name }}</h4>
                                                    <p>@{{ user_obj.username }}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ user_obj.email }}</td>
                                        <td>
                                            <span class="admin-badge {% if user_obj.is_superuser %}yes{% else %}no{% endif %}">
                                                {{ user_obj.is_superuser|yesno:"Admin,User" }}
                                            </span>
                                        </td>
                                        <td>
                                            {% with profile_form=user_profile_forms|get_item:user_obj.id %}
                                                {{ profile_form.admin_groups }}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center py-5">
                                            <i class="material-icons d-block mb-3" style="font-size: 3rem; color: #9ca3af;">person_off</i>
                                            <h4 class="text-muted">No users found</h4>
                                            <p class="text-muted">Try adjusting your search criteria</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if users_to_promote.paginator.num_pages > 1 %}
                        <div class="pagination-container">
                            <nav aria-label="User pagination">
                                <ul class="pagination">
                                {% if users_to_promote.has_previous %}
                                <li class="page-item">
                                        <a class="page-link" href="?user_page=1{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}">
                                            <i class="material-icons">first_page</i>
                                    </a>
                                </li>
                                <li class="page-item">
                                        <a class="page-link" href="?user_page={{ users_to_promote.previous_page_number }}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}">
                                            <i class="material-icons">chevron_left</i>
                                    </a>
                                </li>
                                {% endif %}
                                    
                                {% for num in users_to_promote.paginator.page_range %}
                                    {% if users_to_promote.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                    {% elif num > users_to_promote.number|add:'-3' and num < users_to_promote.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?user_page={{ num }}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}">{{ num }}</a>
                                            </li>
                                    {% endif %}
                                {% endfor %}
                                    
                                {% if users_to_promote.has_next %}
                                <li class="page-item">
                                        <a class="page-link" href="?user_page={{ users_to_promote.next_page_number }}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}">
                                            <i class="material-icons">chevron_right</i>
                                    </a>
                                </li>
                                <li class="page-item">
                                        <a class="page-link" href="?user_page={{ users_to_promote.paginator.num_pages }}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}">
                                            <i class="material-icons">last_page</i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button type="submit" name="promote_users_submit" class="btn btn-primary-admin">
                                <i class="material-icons">save</i>
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Groups Tab -->
        <div class="tab-pane fade" id="groups" role="tabpanel">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>
                        <i class="material-icons">group_add</i>
                        Group Management
                    </h2>
                </div>
                <div class="admin-card-body">
                    <!-- Search -->
                    <div class="search-container">
                        <form method="get" class="search-form">
                            <input type="text" 
                                   name="group_search" 
                                   value="{{ group_search }}" 
                                   class="search-input" 
                                   placeholder="Search groups...">
                            <button type="submit" class="search-btn">
                                <i class="material-icons">search</i>
                                Search
                                </button>
                                {% if group_search %}
                            <a href="?{% if request.GET.user_search %}user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}" 
                               class="btn btn-outline-secondary">
                                <i class="material-icons">clear</i>
                                Clear
                                </a>
                                {% endif %}
                        </form>
                    </div>

                    <!-- Create Group Button -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="mb-0">Groups</h3>
                        <button type="button" class="btn btn-primary-admin" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                            <i class="material-icons">add_circle</i>
                            Create Group
                        </button>
                    </div>

                    <!-- Groups Table -->
                    {% if all_groups %}
                        <div class="table-responsive">
                        <table class="user-table">
                                <thead>
                                    <tr>
                                    <th>Group Name</th>
                                    <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group in all_groups %}
                                    <tr>
                                        <td>
                                        <div class="user-info">
                                            <div class="user-avatar">
                                                {% if group.logo_base64 %}
                                                    <img src="data:image/png;base64,{{ group.logo_base64 }}" 
                                                         alt="{{ group.name }}"
                                                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                                {% else %}
                                                    <i class="material-icons">group</i>
                                                {% endif %}
                                            </div>
                                            <div class="user-details">
                                                <h4>{{ group.name }}</h4>
                                                <p>{{ group.description|safe|truncatechars_html:80|default:"No description" }}</p>
                                                {% if group.contact_email %}
                                                <div class="group-meta">
                                                    <small class="text-muted">
                                                        <i class="material-icons" style="font-size: 0.75rem;">email</i>
                                                        {{ group.contact_email }}
                                                    </small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        </td>
                                        <td>
                                        <form method="post" class="d-flex gap-2 mb-2">
                                                {% csrf_token %}
                                                {% with rename_form=rename_group_forms|get_item:group.id %}
                                                <input type="text" 
                                                       name="{{ rename_form.name.name }}" 
                                                       value="{{ group.name }}" 
                                                       class="form-control" 
                                                       style="min-width: 300px; max-width: 400px;"
                                                       placeholder="Enter new group name">
                                                {% endwith %}
                                            <button type="submit" name="rename_group_{{ group.id }}" class="btn btn-sm btn-outline-primary action-btn">
                                                    <i class="material-icons">edit</i>
                                                </button>
                                                <input type="hidden" name="group_id" value="{{ group.id }}">
                                            <button type="submit" name="delete_group_submit" class="btn btn-sm btn-outline-danger action-btn" 
                                                    onclick="return confirm('Are you sure you want to delete group \'{{ group.name }}\'?');">
                                                    <i class="material-icons">delete</i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                                {% else %}
                    <div class="text-center py-5">
                        <i class="material-icons d-block mb-3" style="font-size: 3rem; color: #9ca3af;">group_off</i>
                        <h4 class="text-muted">No groups found</h4>
                        <p class="text-muted">Create your first group to get started</p>
                        </div>
                    {% endif %}
                </div>
                        </div>
                    </div>

        <!-- Other tabs will be added here -->
        <div class="tab-pane fade" id="bans" role="tabpanel">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>
                        <i class="material-icons">gavel</i>
                        Ban Management
                    </h2>
                        </div>
                <div class="admin-card-body">
                    <p class="text-muted">Ban management functionality coming soon...</p>
                    </div>
                    </div>
                </div>

        <div class="tab-pane fade" id="banner" role="tabpanel">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>
                        <i class="material-icons">campaign</i>
                        Site Banner
                    </h2>
                                    </div>
                <div class="admin-card-body">
                    <p class="text-muted">Site banner management coming soon...</p>
                                </div>
                                </div>
                                </div>
                                
        <div class="tab-pane fade" id="notify" role="tabpanel">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>
                        <i class="material-icons">notifications</i>
                        Send Notifications
                    </h2>
                                </div>
                <div class="admin-card-body">
                    <p class="text-muted">Notification system coming soon...</p>
                </div>
                        </div>
                    </div>
                    
        {% if user.profile.can_post_blog %}
        <div class="tab-pane fade" id="blog" role="tabpanel">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>
                        <i class="material-icons">rss_feed</i>
                        Blog Management
                    </h2>
                        </div>
                <div class="admin-card-body">
                    <p class="text-muted">Blog management functionality coming soon...</p>
                                        </div>
                                    </div>
                                </div>
        {% endif %}

        <!-- Audit Log Tab -->
        <div class="tab-pane fade" id="audit" role="tabpanel" aria-labelledby="audit-tab">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>
                        <i class="material-icons">history</i>
                        Audit Log
                    </h2>
                </div>
                <div class="admin-card-body">
                    <!-- Audit Log Filters -->
                    <div class="search-container">
                        <form method="get" class="search-form">
                            <input type="text" 
                                   name="audit_search" 
                                   value="{{ audit_search }}" 
                                   class="search-input" 
                                   placeholder="Search audit logs...">
                            <input type="text" 
                                   name="audit_user_filter" 
                                   value="{{ audit_user_filter }}" 
                                   class="search-input" 
                                   placeholder="Filter by username...">
                            <select name="audit_action_filter" class="search-input">
                                <option value="">All Actions</option>
                                {% for action_code, action_name in audit_actions %}
                                    <option value="{{ action_code }}" {% if audit_action_filter == action_code %}selected{% endif %}>{{ action_name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="search-btn">
                                <i class="material-icons">filter_list</i>
                                Filter
                            </button>
                        </form>
                    </div>

                    <!-- Audit Log Table -->
                    <div class="table-responsive">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Description</th>
                                    <th>Group</th>
                                    <th>Event</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log_entry in audit_logs %}
                                <tr>
                                    <td>
                                        <small class="text-muted">{{ log_entry.timestamp|date:"Y-m-d H:i:s" }}</small>
                                    </td>
                                    <td>
                                        {% if log_entry.user %}
                                            <span class="fw-medium">{{ log_entry.user.username }}</span>
                                            {% if log_entry.target_user and log_entry.target_user != log_entry.user %}
                                                <small class="text-muted d-block">â†’ {{ log_entry.target_user.username }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">System</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="admin-badge yes">
                                            {{ log_entry.get_action_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="text-wrap" style="max-width: 300px;">
                                            {{ log_entry.description }}
                                        </div>
                                    </td>
                                    <td>
                                        {% if log_entry.group %}
                                            <span class="admin-badge yes">
                                                {{ log_entry.group.name }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log_entry.event %}
                                            <span class="admin-badge yes">
                                                {{ log_entry.event.title }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ log_entry.ip_address|default:"-" }}</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-5">
                                        <i class="material-icons d-block mb-3" style="font-size: 3rem; color: #9ca3af;">history</i>
                                        <h4 class="text-muted">No audit log entries found</h4>
                                        <p class="text-muted">No audit log entries match your search criteria</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Audit Log Pagination -->
                    {% if audit_logs.paginator.num_pages > 1 %}
                    <div class="pagination-container">
                        <nav aria-label="Audit log pagination">
                            <ul class="pagination">
                            {% if audit_logs.has_previous %}
                            <li class="page-item">
                                    <a class="page-link" href="?audit_page=1{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}{% if request.GET.audit_search %}&audit_search={{ request.GET.audit_search }}{% endif %}{% if request.GET.audit_user_filter %}&audit_user_filter={{ request.GET.audit_user_filter }}{% endif %}{% if request.GET.audit_action_filter %}&audit_action_filter={{ request.GET.audit_action_filter }}{% endif %}">
                                        <i class="material-icons">first_page</i>
                                </a>
                            </li>
                            <li class="page-item">
                                    <a class="page-link" href="?audit_page={{ audit_logs.previous_page_number }}{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}{% if request.GET.audit_search %}&audit_search={{ request.GET.audit_search }}{% endif %}{% if request.GET.audit_user_filter %}&audit_user_filter={{ request.GET.audit_user_filter }}{% endif %}{% if request.GET.audit_action_filter %}&audit_action_filter={{ request.GET.audit_action_filter }}{% endif %}">
                                        <i class="material-icons">chevron_left</i>
                                </a>
                            </li>
                            {% endif %}
                                
                            {% for num in audit_logs.paginator.page_range %}
                                {% if audit_logs.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                {% elif num > audit_logs.number|add:'-3' and num < audit_logs.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?audit_page={{ num }}{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}{% if request.GET.audit_search %}&audit_search={{ request.GET.audit_search }}{% endif %}{% if request.GET.audit_user_filter %}&audit_user_filter={{ request.GET.audit_user_filter }}{% endif %}{% if request.GET.audit_action_filter %}&audit_action_filter={{ request.GET.audit_action_filter }}{% endif %}">{{ num }}</a>
                                        </li>
                                {% endif %}
                            {% endfor %}
                                
                            {% if audit_logs.has_next %}
                            <li class="page-item">
                                    <a class="page-link" href="?audit_page={{ audit_logs.next_page_number }}{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}{% if request.GET.audit_search %}&audit_search={{ request.GET.audit_search }}{% endif %}{% if request.GET.audit_user_filter %}&audit_user_filter={{ request.GET.audit_user_filter }}{% endif %}{% if request.GET.audit_action_filter %}&audit_action_filter={{ request.GET.audit_action_filter }}{% endif %}">
                                        <i class="material-icons">chevron_right</i>
                                </a>
                            </li>
                            <li class="page-item">
                                    <a class="page-link" href="?audit_page={{ audit_logs.paginator.num_pages }}{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}{% if request.GET.user_search %}&user_search={{ request.GET.user_search }}{% endif %}{% if request.GET.group_search %}&group_search={{ request.GET.group_search }}{% endif %}{% if request.GET.audit_search %}&audit_search={{ request.GET.audit_search }}{% endif %}{% if request.GET.audit_user_filter %}&audit_user_filter={{ request.GET.audit_user_filter }}{% endif %}{% if request.GET.audit_action_filter %}&audit_action_filter={{ request.GET.audit_action_filter }}{% endif %}">
                                        <i class="material-icons">last_page</i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
                            </div>
                            </div>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createGroupModalLabel">
                    <i class="material-icons me-2">add_circle</i>
                    Create New Group
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
            <form method="post">
                            {% csrf_token %}
                <div class="modal-body">
                        <div class="mb-3">
                        <label for="new_group_name" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="new_group_name" name="new_group_name" required>
                            </div>
                            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="create_group_submit" class="btn btn-primary-admin">
                        <i class="material-icons me-2">add</i>
                        Create Group
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

<!-- Add User to Group Modal -->
<div class="modal fade" id="addUserToGroupModal" tabindex="-1" aria-labelledby="addUserToGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserToGroupModalLabel">
                    <i class="material-icons me-2">person_add</i>
                    Add User to Group
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                <div class="modal-body">
                        <div class="mb-3">
                        <label class="form-label">Group</label>
                        <input type="text" class="form-control" id="selectedGroupName" readonly>
                        <input type="hidden" id="selectedGroupId" name="add_user_group_id">
                        </div>
                        <div class="mb-3">
                        <label for="userSearch" class="form-label">Search Users</label>
                        <input type="text" class="form-control" id="userSearch" placeholder="Search by username, email, or display name...">
                        </div>
                    <div class="mb-3">
                        <label class="form-label">Select Users to Add</label>
                        <div id="userList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="material-icons">search</i>
                                <p>Search for users above to add them to the group</p>
                                        </div>
                                    </div>
                                </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="add_users_to_group" class="btn btn-primary-admin">
                        <i class="material-icons me-2">add</i>
                        Add Selected Users
                    </button>
                </div>
            </form>
            </div>
        </div>
    </div>

{% block extra_js %}
{% endblock %}
{% endblock %}