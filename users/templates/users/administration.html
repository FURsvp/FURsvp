{% extends 'events/base.html' %}
{% load users_extras %}
{% load widget_tweaks %}
{% block title %}Administration - FURsvp{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
            <h1 class="display-5 mb-4 text-center">
                <i class="material-icons align-middle me-2">admin_panel_settings</i> Administration Panel
            </h1>

            <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="organizers-tab" data-bs-toggle="tab" data-bs-target="#organizers" type="button" role="tab" aria-controls="organizers" aria-selected="true">
                        <i class="material-icons align-middle me-1">manage_accounts</i> Promote/Demote Organizers
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab" aria-controls="groups" aria-selected="false">
                        <i class="material-icons align-middle me-1">group_add</i> Manage Groups
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bans-tab" data-bs-toggle="tab" data-bs-target="#bans" type="button" role="tab" aria-controls="bans" aria-selected="false">
                        <i class="material-icons align-middle me-1">gavel</i> Ban Users
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="adminTabsContent">
                <div class="tab-pane fade show active" id="organizers" role="tabpanel" aria-labelledby="organizers-tab">
                    <h2 class="card-title h4 mb-4 text-primary fw-bold">
                        <i class="material-icons me-2">people</i> Promote/Demote Organizers
                    </h2>
                    <!-- Search Bar for Users -->
                    <div class="mb-4">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="material-icons">search</i>
                            </span>
                            <input type="text" id="userSearch" class="form-control" placeholder="Search users by username or email...">
                        </div>
                    </div>
                    <form method="post">
                        {% csrf_token %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle caption-top mb-0" id="usersTable">
                                <thead>
                                    <tr>
                                        <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">person</i> Username</th>
                                        <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">email</i> Email</th>
                                        <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">admin_panel_settings</i> Site Admin</th>
                                        <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">group</i> Admin Groups</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user_obj in users_to_promote %}
                                    <tr>
                                        <td>{{ user_obj.profile.get_display_name }}</td>
                                        <td>{{ user_obj.email }}</td>
                                        <td>
                                            <span class="badge {% if user_obj.is_superuser %}bg-success{% else %}bg-danger{% endif %} py-2 px-3 rounded-pill fw-normal">
                                                {{ user_obj.is_superuser|yesno:"Yes,No" }}
                                            </span>
                                        </td>
                                        <td>
                                            {% with profile_form=user_profile_forms|get_item:user_obj.id %}
                                                {{ profile_form.allowed_groups|add_class:"tomselect-allowed-groups form-select form-select-sm" }}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">
                                            <i class="material-icons d-block mb-2 fs-1">person_off</i>
                                            No users found.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- User Pagination -->
                        {% if users_to_promote.paginator.num_pages > 1 %}
                        <nav aria-label="User list pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if users_to_promote.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?user_page=1{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}" aria-label="First">
                                            <i class="material-icons">first_page</i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?user_page={{ users_to_promote.previous_page_number }}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}" aria-label="Previous">
                                            <i class="material-icons">chevron_left</i>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for num in users_to_promote.paginator.page_range %}
                                    {% if users_to_promote.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > users_to_promote.number|add:'-3' and num < users_to_promote.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?user_page={{ num }}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if users_to_promote.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?user_page={{ users_to_promote.next_page_number }}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}" aria-label="Next">
                                            <i class="material-icons">chevron_right</i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?user_page={{ users_to_promote.paginator.num_pages }}{% if request.GET.group_page %}&group_page={{ request.GET.group_page }}{% endif %}" aria-label="Last">
                                            <i class="material-icons">last_page</i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="submit" name="promote_users_submit" class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm">
                                <i class="material-icons me-2">save</i> Update Approval Status
                            </button>
                        </div>
                    </form>
                </div>
                <div class="tab-pane fade" id="groups" role="tabpanel" aria-labelledby="groups-tab">
                    <h2 class="card-title h4 mb-4 text-primary fw-bold">
                        <i class="material-icons me-2">groups</i> Manage Groups
                    </h2>
                    <!-- Search Bar for Groups -->
                    <div class="mb-4">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="material-icons">search</i>
                            </span>
                            <input type="text" id="groupSearch" class="form-control" placeholder="Search groups...">
                        </div>
                    </div>
                    <!-- Create New Group Form -->
                    <div class="card bg-light border-0 rounded-3 mb-4">
                        <div class="card-body">
                            <h3 class="h5 mb-3 text-secondary">
                                <i class="material-icons me-2">add_circle</i> Create New Group
                            </h3>
                            <form method="post">
                                {% csrf_token %}
                                <div class="row g-3 align-items-center">
                                    <div class="col-sm-auto flex-grow-1">
                                        {{ group_form.name|add_class:"form-control form-control-lg"|attr:"placeholder:Enter group name" }}
                                    </div>
                                    <div class="col-sm-auto">
                                        <button type="submit" name="create_group_submit" class="btn btn-success btn-lg rounded-pill px-4 shadow-sm">
                                            <i class="material-icons me-2">add</i> Create Group
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Existing Groups Table -->
                    <h3 class="h5 mb-3 text-secondary">
                        <i class="material-icons me-2">list</i> Existing Groups
                    </h3>
                    {% if all_groups %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle caption-top mb-0" id="groupsTable">
                                <thead>
                                    <tr>
                                        <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">label</i> Group Name</th>
                                        <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">edit</i> Rename</th>
                                        <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">delete</i> Delete</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group in all_groups %}
                                    <tr>
                                        <td><span class="badge bg-info text-dark py-2 px-3 rounded-pill fw-normal">{{ group.name }}</span></td>
                                        <td>
                                            <form method="post" class="d-flex gap-2">
                                                {% csrf_token %}
                                                {% with rename_form=rename_group_forms|get_item:group.id %}
                                                    {{ rename_form.name|add_class:"form-control form-control-sm"|attr:"placeholder:Rename group" }}
                                                {% endwith %}
                                                <button type="submit" name="rename_group_{{ group.id }}" class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                                    <i class="material-icons">edit</i>
                                                </button>
                                            </form>
                                        </td>
                                        <td>
                                            <form method="post" class="d-inline"
                                                  onsubmit="return confirm('Are you sure you want to delete group \'{{ group.name }}\'?');">
                                                {% csrf_token %}
                                                <input type="hidden" name="group_id" value="{{ group.id }}">
                                                <button type="submit" name="delete_group_submit" class="btn btn-sm btn-outline-danger rounded-pill px-3">
                                                    <i class="material-icons">delete</i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">
                                            <i class="material-icons d-block mb-2 fs-1">info</i>
                                            No groups found.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Group Pagination -->
                        {% if all_groups.paginator.num_pages > 1 %}
                        <nav aria-label="Group list pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if all_groups.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?group_page=1{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}" aria-label="First">
                                            <i class="material-icons">first_page</i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?group_page={{ all_groups.previous_page_number }}{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}" aria-label="Previous">
                                            <i class="material-icons">chevron_left</i>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for num in all_groups.paginator.page_range %}
                                    {% if all_groups.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > all_groups.number|add:'-3' and num < all_groups.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?group_page={{ num }}{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if all_groups.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?group_page={{ all_groups.next_page_number }}{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}" aria-label="Next">
                                            <i class="material-icons">chevron_right</i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?group_page={{ all_groups.paginator.num_pages }}{% if request.GET.user_page %}&user_page={{ request.GET.user_page }}{% endif %}" aria-label="Last">
                                            <i class="material-icons">last_page</i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info border-0 rounded-3 text-muted">
                            <i class="material-icons me-2">info</i>
                            No groups created yet.
                        </div>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="bans" role="tabpanel" aria-labelledby="bans-tab">
                    <h2 class="card-title h4 mb-4 text-primary fw-bold">
                        <i class="material-icons me-2">group_off</i> Manage Bans
                    </h2>
                    <!-- Search Bar for Bans -->
                    <div class="mb-4">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="material-icons">search</i>
                            </span>
                            <input type="text" id="banSearch" class="form-control" placeholder="Search banned users...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle caption-top mb-0" id="bansTable">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">person</i> Banned User</th>
                                    <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">group</i> Group</th>
                                    <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">admin_panel_settings</i> Banned By</th>
                                    <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">description</i> Reason</th>
                                    <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">event</i> Banned At</th>
                                    <th scope="col" class="text-secondary"><i class="material-icons me-1 opacity-75">cancel</i> Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for banned_entry in all_banned_users %}
                                <tr>
                                    <td>{{ banned_entry.user.profile.get_display_name }}</td>
                                    <td>{{ banned_entry.group.name }}</td>
                                    <td>{{ banned_entry.banned_by.username|default:"N/A" }}</td>
                                    <td>{{ banned_entry.reason|default:"No reason provided" }}</td>
                                    <td>{{ banned_entry.banned_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success rounded-pill px-3 unban-btn" 
                                                data-user-id="{{ banned_entry.user.id }}"
                                                data-group-id="{{ banned_entry.group.id }}">
                                            <i class="material-icons me-1">lock_open</i> Unban
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No users currently banned.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded. Attempting to initialize TomSelect.');
        const elements = document.querySelectorAll('select.tomselect-allowed-groups');
        console.log(`Found ${elements.length} elements with class 'tomselect-allowed-groups'.`);
        elements.forEach(function(element) {
            console.log('Initializing TomSelect for element:', element);
            new TomSelect(element, {
                plugins: {
                    remove_button: {
                        title: 'Remove this item',
                    }
                },
                dropdownParent: 'body',
                create: false, // Prevent users from creating new options
                onInitialize: function() {
                    // Add modern styling to TomSelect elements
                    this.wrapper.classList.add('form-select-sm', 'rounded-pill');
                    this.control.classList.add('rounded-pill');
                    this.dropdown.classList.add('shadow', 'rounded-3');
                }
            });
        });

        // Group search functionality
        const groupSearch = document.getElementById('groupSearch');
        const groupsTable = document.getElementById('groupsTable');
        
        if (groupSearch && groupsTable) {
            groupSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = groupsTable.getElementsByTagName('tr');
                
                for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header
                    const row = rows[i];
                    const groupName = row.querySelector('td:first-child').textContent.toLowerCase();
                    const allowedGroupsSelect = row.querySelector('.tomselect-allowed-groups');
                    let hasMatch = groupName.includes(searchTerm);
                    
                    // Search through the allowed groups select options
                    if (allowedGroupsSelect) {
                        const options = allowedGroupsSelect.options;
                        for (let j = 0; j < options.length; j++) {
                            if (options[j].text.toLowerCase().includes(searchTerm)) {
                                hasMatch = true;
                                break;
                            }
                        }
                    }
                    
                    row.style.display = hasMatch ? '' : 'none';
                }
            });
        }

        // Ban search functionality
        const banSearch = document.getElementById('banSearch');
        const bansTable = document.getElementById('bansTable');
        
        if (banSearch && bansTable) {
            banSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = bansTable.getElementsByTagName('tr');
                
                for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header
                    const row = rows[i];
                    const userCell = row.querySelector('td:first-child');
                    const groupCell = row.querySelector('td:nth-child(2)');
                    
                    if (userCell && groupCell) {
                        const userText = userCell.textContent.toLowerCase();
                        const groupText = groupCell.textContent.toLowerCase();
                        row.style.display = (userText.includes(searchTerm) || groupText.includes(searchTerm)) ? '' : 'none';
                    }
                }
            });
        }

        // User search functionality
        const userSearch = document.getElementById('userSearch');
        const usersTable = document.getElementById('usersTable');
        
        if (userSearch && usersTable) {
            userSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = usersTable.getElementsByTagName('tr');
                
                for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header
                    const row = rows[i];
                    const username = row.querySelector('td:first-child').textContent.toLowerCase();
                    const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    row.style.display = (username.includes(searchTerm) || email.includes(searchTerm)) ? '' : 'none';
                }
            });
        }

        // Handle unban buttons
        document.querySelectorAll('.unban-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const userId = this.dataset.userId;
                const groupId = this.dataset.groupId;
                
                if (!confirm('Are you sure you want to unban this user?')) {
                    return;
                }

                const formData = new FormData();
                formData.append('user_id', userId);
                formData.append('group_id', groupId);
                formData.append('action', 'unban');
                formData.append('ban_type', 'group');

                try {
                    const response = await fetch('{% url "ban_user" %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while processing your request.');
                }
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}

<style>
    .breadcrumb {
        font-size: 1.1rem;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        content: "›";
        font-size: 1.5rem;
        line-height: 1;
        color: #6c757d;
    }
    
    .breadcrumb-item a {
        color: #6c757d;
        transition: color 0.2s ease-in-out;
    }
    
    .breadcrumb-item a:hover {
        color: var(--primary-color);
    }
    
    .breadcrumb-item.active {
        color: var(--primary-color);
    }
</style>