{% extends 'events/base.html' %}
{% block title %}Create Event - FURsvp{% endblock %}
{% load widget_tweaks %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="/" class="text-decoration-none d-flex align-items-center">
                            <i class="material-icons me-1">home</i> Events
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <span class="text-primary">Create Event</span>
                    </li>
                </ol>
            </nav>

            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <i class="material-icons text-primary me-2" style="font-size: 2.5rem;">add_circle</i>
                        <h1 class="card-title display-5 mb-0">Create New Event</h1>
                    </div>

                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Title Field -->
                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                                <i class="material-icons align-middle me-1">event_note</i>
                                Event Title
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="material-icons text-primary">edit</i>
                                </span>
                                {{ form.title|attr:'placeholder:Event Title' }}
                            </div>
                            {% if form.title.help_text %}
                                <div class="form-text">{{ form.title.help_text }}</div>
                            {% endif %}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.title.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Group Field -->
                        <div class="mb-4">
                            <label for="{{ form.group.id_for_label }}" class="form-label fw-bold">
                                <i class="material-icons align-middle me-1">groups</i>
                                Group
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="material-icons text-primary">groups</i>
                                </span>
                                {{ form.group|add_class:'form-control' }}
                            </div>
                            {% if form.group.help_text %}
                                <div class="form-text">{{ form.group.help_text }}</div>
                            {% endif %}
                            {% if form.group.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.group.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Date/Time Fields -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="material-icons align-middle me-1">schedule</i>
                                Date and Time
                            </label>
                            <div class="row">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="material-icons text-primary">event</i>
                                    </span>
                                        {{ form.date|attr:'placeholder:Select date' }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="material-icons text-primary">schedule</i>
                                        </span>
                                        {{ form.start_time|attr:'placeholder:Start time' }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="material-icons text-primary">schedule</i>
                                    </span>
                                        {{ form.end_time|attr:'placeholder:End time' }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Fields -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="material-icons align-middle me-1">place</i>
                                Location
                                </label>
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="material-icons text-primary">place</i>
                                    </span>
                                    {{ form.address|attr:'placeholder:Street address' }}
                                    <button type="button" id="locationButton"
                                        class="btn btn-outline-primary rounded-end" tabindex="-1">
                                        <i class="material-icons">my_location</i>
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="material-icons text-primary">location_city</i>
                                        </span>
                                        {{ form.city|attr:'placeholder:City' }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="material-icons text-primary">map</i>
                                        </span>
                                        {{ form.state|attr:'placeholder:State' }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Age Restriction Field -->
                        <div class="mb-4">
                            <label for="{{ form.age_restriction.id_for_label }}" class="form-label fw-bold">
                                <i class="material-icons align-middle me-1">block</i>
                                Age Restriction
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="material-icons text-primary">block</i>
                                </span>
                                {{ form.age_restriction|add_class:'form-control' }}
                            </div>
                        </div>

                        <!-- Event Capacity Field -->
                        <div class="mb-4">
                            <label for="{{ form.capacity.id_for_label }}" class="form-label fw-bold">
                                Event Capacity
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="material-icons text-primary">people_alt</i>
                                </span>
                                {{ form.capacity|add_class:'form-control'|attr:'placeholder:Enter event capacity (optional)' }}
                            </div>
                            {% if form.capacity.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.capacity.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Waitlist Enabled Field -->
                        <div class="mb-4 form-check form-switch">
                            {{ form.waitlist_enabled|add_class:'form-check-input' }}
                            <label class="form-check-label fw-bold" for="{{ form.waitlist_enabled.id_for_label }}">
                                <i class="material-icons align-middle me-1">add_box</i> Enable Waitlist
                            </label>
                            {% if form.waitlist_enabled.help_text %}
                            <div class="form-text">{{ form.waitlist_enabled.help_text }}</div>
                            {% endif %}
                            {% if form.waitlist_enabled.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.waitlist_enabled.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Description Field -->
                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                                <i class="material-icons align-middle me-1">description</i>
                                Description
                            </label>
                            {{ form.description }}
                        </div>

                        <!-- Agreement Checkboxes -->
                        <div class="mb-4">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <h3 class="h5 fw-bold mb-3">Required Agreements</h3>

                                    <div class="form-check mb-3">
                                        {{ form.eula_agreement }}
                                        <label class="form-check-label" for="{{ form.eula_agreement.id_for_label }}">
                                            {{ form.eula_agreement.label }}
                                            <a href="{% url 'eula' %}" target="_blank" class="ms-1">
                                                <i class="material-icons align-middle"
                                                    style="font-size: 1rem;">open_in_new</i>
                                            </a>
                                        </label>
                                        {% if form.eula_agreement.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.eula_agreement.errors }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="form-check">
                                        {{ form.state_agreement }}
                                        <label class="form-check-label" for="{{ form.state_agreement.id_for_label }}">
                                            {{ form.state_agreement.label }}
                                        </label>
                                        {% if form.state_agreement.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.state_agreement.errors }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-5">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="material-icons me-2">add</i> Create Event
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                                <i class="material-icons me-2">arrow_back</i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
{{ form.media }}
<script src="https://cdn.jsdelivr.net/npm/tinymce@7.9.1/tinymce.min.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize address autocomplete
        const addressInput = document.getElementById('{{ form.address.id_for_label }}');
        const stateInput = document.getElementById('{{ form.state.id_for_label }}');
        const cityInput = document.getElementById('{{ form.city.id_for_label }}');
        let searchTimeout;
        let lastRequestTime = 0;
        const MIN_REQUEST_INTERVAL = 1000; // 1 second between requests
        let userLocation = null;

        // Get user location when page loads
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                },
                (error) => {
                    console.error('Error getting location:', error);
                }
            );
        }

        // Create autocomplete container
        const autocompleteContainer = document.createElement('div');
        autocompleteContainer.className = 'autocomplete-container';
        autocompleteContainer.style.cssText = `
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            margin-top: 4px;
            top: 100%;
        `;
        addressInput.parentElement.style.position = 'relative';
        addressInput.parentElement.appendChild(autocompleteContainer);

        // Handle address input
        addressInput.addEventListener('input', function (e) {
            e.preventDefault(); // Prevent default to avoid URL showing
            clearTimeout(searchTimeout);
            const query = this.value;

            if (query.length < 3) {
                autocompleteContainer.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                const now = Date.now();
                const timeSinceLastRequest = now - lastRequestTime;

                if (timeSinceLastRequest < MIN_REQUEST_INTERVAL) {
                    setTimeout(() => {
                        performSearch(query);
                    }, MIN_REQUEST_INTERVAL - timeSinceLastRequest);
                } else {
                    performSearch(query);
                }
            }, 300);
        });

        // Prevent form submission on enter
        addressInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        // Add keyboard navigation
        addressInput.addEventListener('keydown', function (e) {
            const suggestions = autocompleteContainer.getElementsByClassName('autocomplete-suggestion');
            const activeSuggestion = autocompleteContainer.querySelector(
                '.autocomplete-suggestion.active');
            let index = Array.from(suggestions).indexOf(activeSuggestion);

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (index < suggestions.length - 1) {
                        if (activeSuggestion) activeSuggestion.classList.remove('active');
                        suggestions[index + 1].classList.add('active');
                        suggestions[index + 1].scrollIntoView({
                            block: 'nearest'
                        });
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (index > 0) {
                        if (activeSuggestion) activeSuggestion.classList.remove('active');
                        suggestions[index - 1].classList.add('active');
                        suggestions[index - 1].scrollIntoView({
                            block: 'nearest'
                        });
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (activeSuggestion) {
                        activeSuggestion.click();
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    autocompleteContainer.style.display = 'none';
                    break;
            }
        });

        function performSearch(query) {
            lastRequestTime = Date.now();

            // Get existing city and state values
            const existingCity = cityInput.value.trim();
            const existingState = stateInput.value.trim();

            // Build the search query
            let searchQuery = query;
            if (existingCity && existingState) {
                searchQuery = `${query} ${existingCity} ${existingState}`;
            }

            let searchUrl =
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=us&addressdetails=1&limit=10`;

            // If we have user location, add it to the search to prioritize nearby results
            if (userLocation) {
                searchUrl += `&lat=${userLocation.lat}&lon=${userLocation.lon}&radius=50000`; // 50km radius
            }

            fetch(searchUrl, {
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'FURsvp/1.0',
                        'Referer': window.location.origin
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data || data.length === 0) {
                        autocompleteContainer.style.display = 'none';
                        return;
                    }

                    // Clear existing suggestions
                    autocompleteContainer.innerHTML = '';

                    // Add new suggestions
                    data.forEach(result => {
                        const address = result.address;
                        let streetAddress = '';
                        let fullAddress = '';

                        if (address.road) {
                            streetAddress = address.road;
                            fullAddress = address.road;
                            if (address.house_number) {
                                streetAddress = address.house_number + ' ' + streetAddress;
                                fullAddress = address.house_number + ' ' + fullAddress;
                            }
                            // Add city and state to the full address only
                            if (address.city || address.town || address.village) {
                                fullAddress += ', ' + (address.city || address.town ||
                                    address.village);
                            }
                            if (address.state) {
                                fullAddress += ', ' + address.state;
                            }
                        }

                        if (streetAddress) {
                            const suggestion = document.createElement('div');
                            suggestion.className = 'autocomplete-suggestion';
                            suggestion.style.cssText = `
                        padding: 8px 12px;
                        cursor: pointer;
                        border-bottom: 1px solid #eee;
                    `;
                            suggestion.textContent = fullAddress;
                            suggestion.addEventListener('click', () => {
                                // Set only the street address in the address field
                                addressInput.value = streetAddress;
                                // Update city and state fields separately
                                if (address.state) {
                                    stateInput.value = address.state;
                                }
                                if (address.city || address.town || address.village) {
                                    cityInput.value = address.city || address.town ||
                                        address.village;
                                }
                                autocompleteContainer.style.display = 'none';
                            });
                            suggestion.addEventListener('mouseover', () => {
                                // Remove active class from all suggestions
                                Array.from(autocompleteContainer.getElementsByClassName(
                                    'autocomplete-suggestion')).forEach(s => {
                                    s.classList.remove('active');
                                });
                                suggestion.classList.add('active');
                                suggestion.style.backgroundColor = '#f5f5f5';
                            });
                            suggestion.addEventListener('mouseout', () => {
                                suggestion.style.backgroundColor = 'white';
                            });
                            autocompleteContainer.appendChild(suggestion);
                        }
                    });

                    // Add active class to first suggestion
                    const firstSuggestion = autocompleteContainer.querySelector('.autocomplete-suggestion');
                    if (firstSuggestion) {
                        firstSuggestion.classList.add('active');
                    }

                    autocompleteContainer.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching address:', error);
                    autocompleteContainer.style.display = 'none';
                });
        }

        // Handle location button click
        const locationButton = document.getElementById('locationButton');
        locationButton.addEventListener('click', (e) => {
            e.preventDefault();

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            locationButton.disabled = true;
            locationButton.innerHTML = '<i class="material-icons">hourglass_empty</i>';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                        try {
                            // Search for nearby cities instead of exact location
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&addressdetails=1&zoom=10`, {
                                    method: 'GET',
                                    headers: {
                                        'Accept': 'application/json',
                                        'User-Agent': 'FURsvp/1.0',
                                        'Referer': window.location.origin
                                    }
                                }
                            );

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const data = await response.json();

                            if (data && data.address) {
                                // Create a container for nearby cities
                                const nearbyContainer = document.createElement('div');
                                nearbyContainer.className = 'autocomplete-container';
                                nearbyContainer.style.cssText = `
                            position: absolute;
                            width: 100%;
                            max-height: 200px;
                            overflow-y: auto;
                            background: white;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            z-index: 1000;
                            margin-top: 4px;
                        `;
                                addressInput.parentElement.appendChild(nearbyContainer);

                                // Add the current location as a suggestion
                                const suggestion = document.createElement('div');
                                suggestion.className = 'autocomplete-suggestion';
                                suggestion.style.cssText = `
                            padding: 8px 12px;
                            cursor: pointer;
                            border-bottom: 1px solid #eee;
                        `;
                                suggestion.textContent = data.display_name;
                                suggestion.addEventListener('click', () => {
                                    // Set city and state
                                    if (data.address) {
                                        if (data.address.city || data.address.town || data
                                            .address.village) {
                                            cityInput.value = data.address.city || data
                                                .address.town || data.address.village;
                                        }
                                        if (data.address.state) {
                                            stateInput.value = data.address.state;
                                        }
                                    }
                                    nearbyContainer.remove();
                                });
                                suggestion.addEventListener('mouseover', () => {
                                    suggestion.style.backgroundColor = '#f5f5f5';
                                });
                                suggestion.addEventListener('mouseout', () => {
                                    suggestion.style.backgroundColor = 'white';
                                });
                                nearbyContainer.appendChild(suggestion);

                                // Close suggestions when clicking outside
                                document.addEventListener('click', function closeSuggestions(e) {
                                    if (!nearbyContainer.contains(e.target) && e.target !==
                                        locationButton) {
                                        nearbyContainer.remove();
                                        document.removeEventListener('click',
                                            closeSuggestions);
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('Error fetching nearby cities:', error);
                            alert('Error getting nearby cities. Please try again.');
                        } finally {
                            locationButton.disabled = false;
                            locationButton.innerHTML = '<i class="material-icons">my_location</i>';
                        }
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert(
                            'Error getting your location. Please make sure location services are enabled.'
                            );
                        locationButton.disabled = false;
                        locationButton.innerHTML = '<i class="material-icons">my_location</i>';
                    }
            );
        });

    // Initialize TinyMCE
        function initTinyMCE() {
            const isDark = document.body.classList.contains('dark-mode');
    tinymce.init({
                selector: '#{{ form.description.id_for_label }}',
        height: 300,
        width: '100%',
        menubar: false,
                plugins: 'advlist autolink lists image charmap anchor searchreplace visualblocks code insertdatetime table help wordcount textcolor backcolor',
                toolbar: 'bold italic strikethrough | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | image code | removeformat',
        branding: false,
        promotion: false,
                license_key: 'gpl',
        automatic_uploads: true,
        file_picker_types: 'image',
        images_reuse_filename: true,
                statusbar: false,
                resize: false,
                menubar: false,
                skin: isDark ? 'oxide-dark' : 'oxide',
                content_css: isDark ? '/static/tinymce-dark-content.css' : '',
                toolbar_mode: 'wrap',
                toolbar_sticky: true,
                toolbar_sticky_offset: 0,
                content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px; } img { max-width: 100%; height: auto; display: block; margin: 1em auto; } .tox-statusbar { display: none !important; }',
                document_base_url: '{{ request.scheme }}://{{ request.get_host }}/',
        file_picker_callback: function (callback, value, meta) {
            if (meta.filetype === 'image') {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');

                input.onchange = function () {
                    const file = this.files[0];
                    const reader = new FileReader();
                    reader.onload = function () {
                        const base64data = reader.result;
                                console.log('Base64 data generated:', base64data.substring(
                                    0,
                                    50) + '...');
                        
                        // Create an image element to get dimensions
                        const img = new Image();
                                img.onload = function () {
                            // Calculate dimensions to fit within modal
                            const maxWidth = 800; // Maximum width for images
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                const ratio = maxWidth / width;
                                width = maxWidth;
                                height = height * ratio;
                            }
                            
                            // Insert the image with calculated dimensions
                                    const imageHtml =
                                        `<img src="${base64data}" alt="${file.name}" style="max-width: 100%; width: ${width}px; height: ${height}px; object-fit: contain;" />`;
                                    callback(base64data, {
                                        alt: file.name
                                    });
                        };
                        img.src = base64data;
                    };
                    reader.readAsDataURL(file);
                };

                input.click();
            }
        },
                setup: function (editor) {
                    editor.on('init', function () {
                        editor.getContainer().style.transition =
                            'border-color 0.15s ease-in-out';
                    });
                    editor.on('change', function () {
                console.log('Editor content changed');
            });
                    editor.on('ObjectResized', function (e) {
                console.log('Object resized:', e);
            });
                    editor.on('SetContent', function (e) {
                console.log('Content set:', e);
            });
                    editor.on('BeforeSetContent', function (e) {
                console.log('Before content set:', e);
                    });
                }
            });
        }

        // Initialize TinyMCE on page load
        initTinyMCE();

        // Function to re-initialize TinyMCE when dark mode changes
        function reinitTinyMCE() {
            const editor = tinymce.get('{{ form.description.id_for_label }}');
            if (editor) {
                editor.destroy();
            }
            setTimeout(initTinyMCE, 100);
        }

        // Listen for dark mode changes
        document.addEventListener('darkModeChanged', function (event) {
            setTimeout(reinitTinyMCE, 200);
    });

    // Initialize Flatpickr
    flatpickr("#{{ form.date.id_for_label }}", {
        dateFormat: "Y-m-d",
        minDate: "today",
        disableMobile: "true",
            theme: "light",
        allowInput: true,
        altInput: true,
        altFormat: "F j, Y",
        altInputClass: "form-control",
            onChange: function (selectedDates, dateStr, instance) {
            document.getElementById("{{ form.date.id_for_label }}").value = dateStr;
            },
            onReady: function (selectedDates, dateStr, instance) {
                // Add custom styles to match theme
                const calendar = instance.calendarContainer;
                calendar.style.borderRadius = '8px';
                calendar.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                calendar.style.border = '1px solid #dee2e6';

                // Style the selected date
                const selectedDay = calendar.querySelector('.selected');
                if (selectedDay) {
                    selectedDay.style.backgroundColor = '#0d6efd';
                    selectedDay.style.borderColor = '#0d6efd';
                }

                // Style the current day
                const today = calendar.querySelector('.today');
                if (today) {
                    today.style.borderColor = '#0d6efd';
                }
            }
        });

        // Initialize Flatpickr for start_time
        const startTimePicker = flatpickr("#{{ form.start_time.id_for_label }}", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: false,
            disableMobile: "true",
            theme: "light",
            allowInput: true,
            altInput: true,
            altFormat: "h:i K",
            altInputClass: "form-control",
            onChange: function (selectedDates, dateStr, instance) {
                document.getElementById("{{ form.start_time.id_for_label }}").value = dateStr;
                // Update end time min time when start time changes
                if (endTimePicker) {
                    endTimePicker.set('minTime', dateStr);
                    // If end time is before start time, update it
                    const endTime = endTimePicker.selectedDates[0];
                    if (endTime && endTime < selectedDates[0]) {
                        endTimePicker.setDate(selectedDates[0]);
                    }
                }
            }
        });

        // Initialize Flatpickr for end_time
        const endTimePicker = flatpickr("#{{ form.end_time.id_for_label }}", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: false,
            disableMobile: "true",
            theme: "light",
            allowInput: true,
            altInput: true,
            altFormat: "h:i K",
            altInputClass: "form-control",
            onChange: function (selectedDates, dateStr, instance) {
                document.getElementById("{{ form.end_time.id_for_label }}").value = dateStr;
        }
    });
});
</script>
{% endblock %}