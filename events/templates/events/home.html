{% extends 'events/base.html' %}
{% block title %}Home - FURsvp{% endblock %}

{% block content %}
<style>
    .btn-group .btn.btn-outline-primary {
        border-width: 1px;
    }
    
    /* Mobile-friendly styles */
    @media (max-width: 768px) {
        .sort-btn {
            padding: 0.375rem 0.75rem !important;
            font-size: 0.9rem !important;
        }
        .sort-btn .material-icons {
            font-size: 16px !important;
        }
        .btn-group {
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        .btn-group .btn {
            border-radius: 0.25rem !important;
            margin: 0.125rem;
        }
        .card-body {
            padding: 1rem !important;
        }
        .display-3 {
            font-size: 2.5rem;
        }
        .lead {
            font-size: 1.1rem;
        }
    }
    .hero-gradient {
        background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
        color: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        padding: 2.5rem 2rem 2rem 2rem;
        margin-bottom: 2.5rem;
    }
    .modern-card {
        border-radius: 1.25rem;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        background: #f8fafc;
        overflow: hidden;
        margin-bottom: 2rem;
    }
    .modern-card-header.events {
        background: linear-gradient(90deg, #42f56c 0%, #66f43f 100%);
        color: #fff;
        font-size: 1.25rem;
        font-weight: 700;
        padding: 1.2rem 2rem;
        border-bottom: none;
        display: flex;
        align-items: center;
    }
    .modern-card-body {
        padding: 2rem 2.5rem 1.5rem 2.5rem;
        background: #f8fafc;
        color: #222;
        font-size: 1.08rem;
    }
    /* Dark mode improvements for home screen */
    .dark-mode .modern-card {
        background: #181a20;
        color: #f3f4f6;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
    }
    .dark-mode .modern-card-header.events {
        background: linear-gradient(90deg, #42f56c 0%, #66f43f 100%);
        color: #fff;
    }
    .dark-mode .modern-card-header {
        border-bottom: none;
    }
    .dark-mode .modern-card-body {
        background: #181a20;
        color: #f3f4f6;
    }
    .dark-mode .pretty-toggle-btn,
    .dark-mode .sort-btn,
    .dark-mode .order-toggle-btn,
    .dark-mode .btn-group .btn {
        background: #23272f !important;
        color: #f3f4f6 !important;
        border-color: #374151 !important;
    }
    .dark-mode .pretty-toggle-btn.active,
    .dark-mode .sort-btn.active,
    .dark-mode .order-toggle-btn.active {
        background: linear-gradient(90deg, #2563eb 0%, #0ea5e9 100%) !important;
        color: #fff !important;
    }
    .dark-mode .btn-danger {
        background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%) !important;
        color: #fff !important;
        border: none !important;
    }
    .dark-mode .card,
    .dark-mode .fancy-post-card,
    .dark-mode .modern-event-card {
        background: #23272f !important;
        color: #f3f4f6 !important;
        border: none !important;
    }
    .dark-mode .card-title,
    .dark-mode .fw-bold,
    .dark-mode .display-3,
    .dark-mode .display-6 {
        color: #60a5fa !important;
    }
    .dark-mode .badge.bg-primary {
        background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%) !important;
        color: #fff !important;
    }
    .dark-mode .badge.bg-danger {
        background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%) !important;
        color: #fff !important;
    }
    .dark-mode .badge.bg-warning {
        background: linear-gradient(90deg, #f59e42 0%, #fbbf24 100%) !important;
        color: #92400e !important;
    }
    .dark-mode .btn-light {
        background: #23272f !important;
        color: #f3f4f6 !important;
        border-color: #374151 !important;
    }
    .dark-mode .btn-outline-primary {
        color: #60a5fa !important;
        border-color: #60a5fa !important;
    }
    .dark-mode .btn-outline-primary:hover {
        background: #2563eb !important;
        color: #fff !important;
    }
    .dark-mode .read-more-link,
    .dark-mode .read-more-link2 {
        color: #38bdf8 !important;
    }
    .dark-mode .read-more-link:hover,
    .dark-mode .read-more-link2:hover {
        color: #a5b4fc !important;
    }
    .gradient-sort-btn {
        border: none;
        border-radius: 2rem;
        padding: 0.7rem 2.2rem;
        font-size: 1.13rem;
        font-weight: 700;
        background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
        color: #fff;
        box-shadow: 0 2px 12px rgba(59,130,246,0.10);
        transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
        margin-right: 0.7rem;
        outline: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .gradient-sort-btn:hover, .gradient-sort-btn.active {
        background: linear-gradient(90deg, #2563eb 0%, #0ea5e9 100%);
        color: #fff;
        box-shadow: 0 4px 18px rgba(59,130,246,0.18);
        transform: translateY(-2px) scale(1.04);
    }
    .outline-sort-btn {
        border: 2px solid #3b82f6;
        border-radius: 2rem;
        padding: 0.7rem 2.2rem;
        font-size: 1.13rem;
        font-weight: 700;
        background: transparent;
        color: #3b82f6;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
        margin-right: 0.7rem;
        outline: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .outline-sort-btn:hover, .outline-sort-btn:focus {
        background: linear-gradient(90deg, #e0e7ef 0%, #f8fafc 100%);
        color: #2563eb;
        box-shadow: 0 4px 18px rgba(59,130,246,0.10);
    }
    .gradient-sfw-btn {
        border: none;
        border-radius: 2rem;
        padding: 0.7rem 2.2rem;
        font-size: 1.13rem;
        font-weight: 700;
        background: linear-gradient(90deg, #10b981 0%, #22d3ee 100%);
        color: #fff;
        box-shadow: 0 2px 12px rgba(16,185,129,0.10);
        transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
        margin-right: 0.7rem;
        outline: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 48px;
        line-height: 48px;
    }
    .gradient-sfw-btn:hover, .gradient-sfw-btn:focus {
        background: linear-gradient(90deg, #22d3ee 0%, #10b981 100%);
        color: #fff;
        box-shadow: 0 4px 18px rgba(16,185,129,0.18);
        transform: translateY(-2px) scale(1.04);
    }
    .gradient-danger-btn {
        border: none;
        border-radius: 2rem;
        padding: 0.7rem 2.2rem;
        font-size: 1.13rem;
        font-weight: 700;
        background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        color: #fff;
        box-shadow: 0 2px 12px rgba(239,68,68,0.10);
        transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
        margin: 0.7rem 0;
        outline: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 48px;
        line-height: 48px;
    }
    .gradient-danger-btn:hover, .gradient-danger-btn:focus {
        background: linear-gradient(90deg, #dc2626 0%, #b91c1c 100%);
        color: #fff;
        box-shadow: 0 4px 18px rgba(239,68,68,0.18);
        transform: translateY(-2px) scale(1.04);
    }
    .gradient-toggle-btn {
        border: none;
        border-radius: 1.5rem;
        background: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%);
        color: #fff;
        font-size: 1.13rem;
        padding: 0.7rem 1.2rem;
        margin-left: 0.5rem;
        transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
        box-shadow: 0 2px 12px rgba(99,102,241,0.10);
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    .gradient-toggle-btn:hover, .gradient-toggle-btn.active {
        background: linear-gradient(90deg, #2563eb 0%, #0ea5e9 100%);
        color: #fff;
        box-shadow: 0 4px 18px rgba(99,102,241,0.18);
        transform: translateY(-2px) scale(1.04);
    }
    .order-toggle-btn, .order-toggle-btn .material-icons {
        text-decoration: none !important;
    }
    .sort-btn, .sort-btn .material-icons {
        text-decoration: none !important;
    }
    /* Remove underline from up/down icon */
    #orderToggleBtn .material-icons {
        text-decoration: none !important;
        border-bottom: none !important;
    }
    /* Dark mode improvements for breadcrumbs and hero header buttons */
    .dark-mode .modern-breadcrumbs {
        color: #a5b4fc !important;
    }
    .dark-mode .modern-breadcrumbs .breadcrumb-current,
    .dark-mode .modern-breadcrumbs .material-icons {
        color: #60a5fa !important;
    }
    .dark-mode .hero-gradient {
        background: linear-gradient(90deg, #2563eb 0%, #1a233a 100%) !important;
        box-shadow: 0 8px 32px 0 rgba(59,130,246,0.18);
        border-radius: 2rem;
        border: 1.5px solid #374151;
    }
    .dark-mode .hero-gradient h1 {
        text-shadow: 0 2px 16px #1a233a, 0 1px 0 #2563eb;
    }
    .dark-mode .hero-gradient .btn {
        background: linear-gradient(90deg, #22d3ee 0%, #2563eb 100%) !important;
        color: #fff !important;
        border: none !important;
        box-shadow: 0 2px 12px rgba(34,211,238,0.13);
        border-radius: 1.5rem;
        font-weight: 700;
        transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
    }
    .dark-mode .hero-gradient .btn:hover {
        background: linear-gradient(90deg, #2563eb 0%, #22d3ee 100%) !important;
        transform: translateY(-2px) scale(1.04);
    }
    .dark-mode .modern-card {
        background: linear-gradient(135deg, #181c23 0%, #23293a 100%) !important;
        border: 1.5px solid #23293a !important;
        box-shadow: 0 8px 32px 0 rgba(59,130,246,0.10);
        border-radius: 1.5rem;
    }
    .dark-mode .modern-card-header.events {
        background: linear-gradient(90deg, #22d3ee 0%, #2563eb 100%) !important;
        color: #fff !important;
        border-radius: 1.2rem 1.2rem 0 0;
        font-weight: 800;
        letter-spacing: 0.01em;
    }
    .dark-mode .modern-card-body {
        background: transparent !important;
        color: #e0e7ef !important;
    }
    .dark-mode .gradient-sfw-btn,
    .dark-mode .gradient-danger-btn {
        box-shadow: 0 2px 12px rgba(34,211,238,0.10);
        border-radius: 2rem;
        font-weight: 700;
    }
    .dark-mode .gradient-sfw-btn:hover,
    .dark-mode .gradient-danger-btn:hover {
        filter: brightness(1.1);
        transform: translateY(-2px) scale(1.04);
    }
</style>
<nav aria-label="breadcrumb" class="mb-4">
    <div class="modern-breadcrumbs">
        <span class="breadcrumb-current"><i class="material-icons me-1">home</i> Home</span>
    </div>
</nav>
<div class="container">
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="hero-gradient text-center mb-4">
                <h1 class="display-3 mb-3 fw-bold">FURsvp Event Manager</h1>
                <p class="lead mb-4">Dedicated to helping event organizers of all sizes within the furry community. A quick-and-dirty solution to get a head count, or as a free and hassle-free alternative to mainstream event services. FURsvp is an open-source project created to serve the furry community. We're always looking for feedback and contributions to make the platform better.</p>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mb-2">
                    {% if user.is_authenticated and user.group_roles.all %}
                    <a href="{% url 'create_event' %}" class="btn btn-light btn-lg px-4 gap-3 fw-bold">
                        <i class="material-icons" style="vertical-align: middle; line-height: 1;">add_circle</i> Create an Event
                    </a>
                    {% elif user.is_authenticated%}
                    {% else %}
                    <a href="{% url 'register' %}" class="btn btn-light btn-lg px-4 gap-3 fw-bold">
                        <i class="material-icons" style="vertical-align: middle; line-height: 1;">person_add</i> Register
                    </a>
                    <a href="{% url 'login' %}" class="btn btn-outline-light btn-lg px-4 fw-bold">
                        <i class="material-icons" style="vertical-align: middle; line-height: 1;">login</i> Login
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="modern-card mb-4">
        <div class="modern-card-header events">
            <i class="material-icons me-2">event</i> Upcoming Events
        </div>
        <div class="modern-card-body">
            <!-- Sorting Controls -->
            <div class="row align-items-center justify-content-between mb-3">
                <div class="col-12 mb-3">
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <div class="btn-group" role="group">
                            <a href="#" data-sort="date" data-order="{{ current_order }}"
                                class="gradient-sort-btn{% if current_sort == 'date' %} active{% else %} outline-sort-btn{% endif %} d-flex align-items-center justify-content-center sort-btn"
                                style="padding: .5rem 1rem; font-size: 1.1rem;">
                                <i class="material-icons me-1 align-middle" style="font-size: 20px;">calendar_today</i> Date
                            </a>
                            <a href="#" data-sort="group" data-order="{{ current_order }}"
                                class="{% if current_sort == 'group' %}gradient-sort-btn active{% else %}outline-sort-btn{% endif %} d-flex align-items-center justify-content-center sort-btn"
                                style="padding: .5rem 1rem; font-size: 1.1rem;">
                                <i class="material-icons me-1 align-middle" style="font-size: 20px;">group</i> Group
                            </a>
                            <a href="#" data-sort="title" data-order="{{ current_order }}"
                                class="{% if current_sort == 'title' %}gradient-sort-btn active{% else %}outline-sort-btn{% endif %} d-flex align-items-center justify-content-center sort-btn"
                                style="padding: .5rem 1rem; font-size: 1.1rem;">
                                <i class="material-icons me-1 align-middle" style="font-size: 20px;">title</i> Title
                            </a>
                            <a href="#" data-sort="rsvps" data-order="{{ current_order }}"
                                class="{% if current_sort == 'rsvps' %}gradient-sort-btn active{% else %}outline-sort-btn{% endif %} d-flex align-items-center justify-content-center sort-btn"
                                style="padding: .5rem 1rem; font-size: 1.1rem;">
                                <i class="material-icons me-1 align-middle" style="font-size: 20px;">people</i> RSVPs
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <button type="button" id="toggleAdultEvents" class="gradient-sfw-btn flex-shrink-0"
                            style="width: 190px; min-width: 190px; max-width: 190px; white-space: nowrap; height: 48px; line-height: 48px; display: flex; align-items: center; justify-content: center; margin-top: 0px;">
                            Show 18+/21+
                        </button>
                        <div class="btn-group" role="group">
                            <a href="#" id="orderToggleBtn" data-sort="{{ current_sort }}" data-order="{% if current_order == 'asc' %}desc{% else %}asc{% endif %}"
                                class="gradient-toggle-btn d-flex align-items-center justify-content-center order-toggle-btn flex-shrink-0"
                                style="width: 48px; height: 48px; border-radius: 24px; font-size: 1.15rem; padding: 0; margin-left: 0.5rem;"
                                title="Toggle Order">
                                <i class="material-icons" style="font-size: 24px;">{% if current_order == 'desc' %}arrow_downward{% else %}arrow_upward{% endif %}</i>
                            </a>
                            <button type="button" class="gradient-toggle-btn d-flex align-items-center justify-content-center flex-shrink-0" id="viewToggle"
                                style="width: 48px; height: 48px; border-radius: 24px; font-size: 1.15rem; padding: 0; margin-left: 0.5rem;"
                                title="Toggle View">
                                <i class="material-icons align-middle" style="font-size: 24px;">grid_view</i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% include 'events/events_list_partial.html' %}
        </div>
    </div>
</div>

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const viewToggle = document.getElementById('viewToggle');
        const eventsGrid = document.getElementById('eventsGrid');
        const eventsList = document.getElementById('eventsList');
        const toggleIcon = viewToggle.querySelector('.material-icons');
        const toggleAdult = document.getElementById('toggleAdultEvents');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const sortButtons = document.querySelectorAll('.sort-btn');
        const orderToggleBtn = document.getElementById('orderToggleBtn');

        // Set initial state
        let isListView = localStorage.getItem('eventViewPreference') === 'list';
        let showAdult = false; // Start in SFW mode (green)
        let currentSort = '{{ current_sort }}';
        let currentOrder = '{{ current_order }}';

        // Function to update the UI based on events data
        function updateEventDisplay(eventsHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = eventsHtml;
            const newEventsGrid = tempDiv.querySelector('#eventsGrid');
            const newEventsList = tempDiv.querySelector('#eventsList');
            const newLoadingSpinner = tempDiv.querySelector('#loadingSpinner'); // Get the new spinner too

            if (newEventsGrid && eventsGrid) {
                eventsGrid.innerHTML = newEventsGrid.innerHTML;
            }
            if (newEventsList && eventsList) {
                eventsList.innerHTML = newEventsList.innerHTML;
            }

            // Ensure the correct view is displayed after update
            if (isListView) {
                eventsGrid.style.display = 'none';
                eventsList.style.display = 'block';
            } else {
                eventsGrid.style.display = 'flex';
                eventsList.style.display = 'none';
            }

            // Update the loading spinner in case the full response contains it
            if (newLoadingSpinner && loadingSpinner) {
                loadingSpinner.style.display = newLoadingSpinner.style.display; // Sync display state
            }
        }

        // Function to fetch and update events
        async function fetchEvents(sort, order, adult, page = 1) {
            loadingSpinner.style.display = 'block'; // Show spinner
            try {
                const url = new URL(window.location.href);
                url.searchParams.set('sort', sort);
                url.searchParams.set('order', order);
                url.searchParams.set('adult', adult);
                url.searchParams.set('page', page);

                // Update current sort and order for future interactions
                currentSort = sort;
                currentOrder = order;

                // Update URL in browser history
                history.pushState({ sort: sort, order: order, adult: adult, page: page }, '', url.toString());

                const response = await fetch(url.toString());
                const html = await response.text();
                
                // Extract the content of the event sections from the full HTML response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newEventsGridHtml = doc.querySelector('#eventsGrid').innerHTML;
                const newEventsListHtml = doc.querySelector('#eventsList').innerHTML;
                const newLoadingSpinnerHtml = doc.querySelector('#loadingSpinner').innerHTML;

                // Update the existing elements
                eventsGrid.innerHTML = newEventsGridHtml;
                eventsList.innerHTML = newEventsListHtml;
                loadingSpinner.innerHTML = newLoadingSpinnerHtml;

                // Update pagination if it exists
                const newPagination = doc.querySelector('.modern-pagination-container');
                const existingPagination = document.querySelector('.modern-pagination-container');
                if (newPagination && existingPagination) {
                    existingPagination.innerHTML = newPagination.innerHTML;
                } else if (newPagination && !existingPagination) {
                    // Add pagination if it didn't exist before
                    const eventsContainer = document.querySelector('.modern-card-body');
                    if (eventsContainer) {
                        eventsContainer.appendChild(newPagination.cloneNode(true));
                    }
                } else if (!newPagination && existingPagination) {
                    // Remove pagination if it no longer exists
                    existingPagination.remove();
                }

                // Apply current view preference after update
                if (isListView) {
                    eventsGrid.style.display = 'none';
                    eventsList.style.display = 'block';
                } else {
                    eventsGrid.style.display = 'flex';
                    eventsList.style.display = 'none';
                }

                // Update active state for sort buttons (custom classes)
                sortButtons.forEach(button => {
                    button.classList.remove('gradient-sort-btn', 'outline-sort-btn', 'active');
                    if (button.dataset.sort === currentSort) {
                        button.classList.add('gradient-sort-btn', 'active');
                    } else {
                        button.classList.add('outline-sort-btn');
                    }
                });

                // Update the order toggle button's data-order attribute and icon
                orderToggleBtn.dataset.order = currentOrder;
                const orderIcon = orderToggleBtn.querySelector('.material-icons');
                if (orderIcon) {
                    orderIcon.textContent = currentOrder === 'desc' ? 'arrow_downward' : 'arrow_upward';
                }

                // Re-attach pagination event listeners
                attachPaginationListeners();

            } catch (error) {
                console.error('Error fetching events:', error);
            } finally {
                loadingSpinner.style.display = 'none'; // Hide spinner
            }
        }

        // Function to attach pagination event listeners
        function attachPaginationListeners() {
            const paginationLinks = document.querySelectorAll('.modern-page-link');
            paginationLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    if (href) {
                        const url = new URL(href, window.location.origin);
                        const page = url.searchParams.get('page') || 1;
                        const sort = url.searchParams.get('sort') || currentSort;
                        const order = url.searchParams.get('order') || currentOrder;
                        const adult = url.searchParams.get('adult') || (showAdult ? 'true' : 'false');
                        
                        fetchEvents(sort, order, adult === 'true', page);
                    }
                });
            });
        }

        // Event Listeners for Sorting Buttons
        sortButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const sortType = this.dataset.sort;
                // If clicking the currently active sort button, reverse the order
                const newOrder = (sortType === currentSort) ? (currentOrder === 'asc' ? 'desc' : 'asc') : currentOrder;
                fetchEvents(sortType, newOrder, showAdult, 1); // Reset to page 1 when sorting
            });
        });

        // Event Listener for Order Toggle Button
        orderToggleBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            currentOrder = newOrder; // Update currentOrder immediately
            this.dataset.order = newOrder; // Update dataset.order immediately
            fetchEvents(currentSort, newOrder, showAdult, 1); // Reset to page 1 when changing order
        });

        // Toggle Adult Events
        function toggleAdultEvents() {
            showAdult = !showAdult;
            localStorage.setItem('showAdultEvents', showAdult);
            if (showAdult) {
                toggleAdult.textContent = 'Hide 18+/21+';
                toggleAdult.classList.remove('gradient-sfw-btn');
                toggleAdult.classList.add('gradient-danger-btn');
            } else {
                toggleAdult.textContent = 'Show 18+/21+';
                toggleAdult.classList.remove('gradient-danger-btn');
                toggleAdult.classList.add('gradient-sfw-btn');
            }
            fetchEvents(currentSort, currentOrder, showAdult, 1); // Reset to page 1 when filtering
        }

        toggleAdult.addEventListener('click', toggleAdultEvents);

        // View Toggle (Grid/List)
        function toggleView() {
            isListView = !isListView;
            localStorage.setItem('eventViewPreference', isListView ? 'list' : 'grid');
            if (isListView) {
                eventsGrid.style.display = 'none';
                eventsList.style.display = 'block';
                toggleIcon.textContent = 'view_list';
                viewToggle.classList.add('active');
            } else {
                eventsGrid.style.display = 'flex';
                eventsList.style.display = 'none';
                toggleIcon.textContent = 'grid_view';
                viewToggle.classList.remove('active');
            }
        }

        viewToggle.addEventListener('click', toggleView);

        // Initial display setup
        if (isListView) {
            eventsGrid.style.display = 'none';
            eventsList.style.display = 'block';
            toggleIcon.textContent = 'view_list';
            viewToggle.classList.add('active');
        } else {
            eventsGrid.style.display = 'flex';
            eventsList.style.display = 'none';
            toggleIcon.textContent = 'grid_view';
            viewToggle.classList.remove('active');
        }

        // Initial color and text setup
        if (showAdult) {
            toggleAdult.textContent = 'Hide 18+/21+';
            toggleAdult.classList.remove('gradient-sfw-btn');
            toggleAdult.classList.add('gradient-danger-btn');
        } else {
            toggleAdult.textContent = 'Show 18+/21+';
            toggleAdult.classList.remove('gradient-danger-btn');
            toggleAdult.classList.add('gradient-sfw-btn');
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            const state = event.state;
            if (state) {
                currentSort = state.sort || 'date';
                currentOrder = state.order || 'asc';
                showAdult = state.adult !== false; // Default to true
                const page = state.page || 1;
                fetchEvents(currentSort, currentOrder, showAdult, page); // Re-fetch with historical state
            } else {
                // If no state, it might be the initial page load or a navigation outside our pushState calls
                // Reload page or re-fetch with default parameters to ensure consistency
                fetchEvents('date', 'asc', true, 1);
            }
        });

        // Initial pagination listener attachment
        attachPaginationListeners();
    });
</script>
{% endblock %}
{% endblock %}