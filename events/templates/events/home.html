{% extends 'events/base.html' %}
{% block title %}Home - FURsvp{% endblock %}

{% block content %}
<style>
    .btn-group .btn.btn-outline-primary {
        border-width: 1px;
    }
    
    /* Mobile-friendly styles */
    @media (max-width: 768px) {
        .sort-btn {
            padding: 0.375rem 0.75rem !important;
            font-size: 0.9rem !important;
        }
        .sort-btn .material-icons {
            font-size: 16px !important;
        }
        .btn-group {
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        .btn-group .btn {
            border-radius: 0.25rem !important;
            margin: 0.125rem;
        }
        .card-body {
            padding: 1rem !important;
        }
        .display-3 {
            font-size: 2.5rem;
        }
        .lead {
            font-size: 1.1rem;
        }
    }
    .hero-gradient {
        background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
        color: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        padding: 2.5rem 2rem 2rem 2rem;
        margin-bottom: 2.5rem;
    }
    .modern-card {
        border-radius: 1.25rem;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
        background: #f8fafc;
        overflow: hidden;
        margin-bottom: 2rem;
    }
    .modern-card-header.events {
        background: linear-gradient(90deg, #42f56c 0%, #66f43f 100%);
        color: #fff;
        font-size: 1.25rem;
        font-weight: 700;
        padding: 1.2rem 2rem;
        border-bottom: none;
        display: flex;
        align-items: center;
    }
    .modern-card-body {
        padding: 2rem 2.5rem 1.5rem 2.5rem;
        background: #f8fafc;
        color: #222;
        font-size: 1.08rem;
    }
</style>
<div class="container">
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="hero-gradient text-center mb-4">
                <h1 class="display-3 mb-3 fw-bold">FURsvp Event Manager</h1>
                <p class="lead mb-4">Dedicated to helping event organizers of all sizes within the furry community. A quick-and-dirty solution to get a head count, or as a free and hassle-free alternative to mainstream event services. FURsvp is an open-source project created to serve the furry community. We're always looking for feedback and contributions to make the platform better.</p>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mb-2">
                    {% if user.is_authenticated and user.profile.is_approved_organizer %}
                    <a href="{% url 'create_event' %}" class="btn btn-light btn-lg px-4 gap-3 fw-bold">
                        <i class="material-icons" style="vertical-align: middle; line-height: 1;">add_circle</i> Create an Event
                    </a>
                    {% elif user.is_authenticated%}
                    {% else %}
                    <a href="{% url 'register' %}" class="btn btn-light btn-lg px-4 gap-3 fw-bold">
                        <i class="material-icons" style="vertical-align: middle; line-height: 1;">person_add</i> Register
                    </a>
                    <a href="{% url 'login' %}" class="btn btn-outline-light btn-lg px-4 fw-bold">
                        <i class="material-icons" style="vertical-align: middle; line-height: 1;">login</i> Login
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="modern-card mb-4">
        <div class="modern-card-header events">
            <i class="material-icons me-2">event</i> Upcoming Events
        </div>
        <div class="modern-card-body">
            <!-- Sorting Controls -->
            <div class="row align-items-center justify-content-between mb-3">
                <div class="col-12 mb-3">
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <div class="btn-group" role="group">
                            <a href="#" data-sort="date" data-order="{{ current_order }}"
                                class="btn {% if current_sort == 'date' %}btn-primary text-white{% else %}btn-outline-primary{% endif %} d-flex align-items-center justify-content-center sort-btn"
                                style="padding: .5rem 1rem; font-size: 1.1rem;">
                                <i class="material-icons me-1 align-middle" style="font-size: 20px;">calendar_today</i> Date
                            </a>
                            <a href="#" data-sort="group" data-order="{{ current_order }}"
                                class="btn {% if current_sort == 'group' %}btn-primary text-white{% else %}btn-outline-primary{% endif %} d-flex align-items-center justify-content-center sort-btn"
                                style="padding: .5rem 1rem; font-size: 1.1rem;">
                                <i class="material-icons me-1 align-middle" style="font-size: 20px;">group</i> Group
                            </a>
                            <a href="#" data-sort="title" data-order="{{ current_order }}"
                                class="btn {% if current_sort == 'title' %}btn-primary text-white{% else %}btn-outline-primary{% endif %} d-flex align-items-center justify-content-center sort-btn"
                                style="padding: .5rem 1rem; font-size: 1.1rem;">
                                <i class="material-icons me-1 align-middle" style="font-size: 20px;">title</i> Title
                            </a>
                            <a href="#" data-sort="rsvps" data-order="{{ current_order }}"
                                class="btn {% if current_sort == 'rsvps' %}btn-primary text-white{% else %}btn-outline-primary{% endif %} d-flex align-items-center justify-content-center sort-btn"
                                style="padding: .5rem 1rem; font-size: 1.1rem;">
                                <i class="material-icons me-1 align-middle" style="font-size: 20px;">people</i> RSVPs
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <button type="button" id="toggleAdultEvents" class="btn btn-danger flex-shrink-0"
                            style="width: 190px; min-width: 190px; max-width: 190px; padding: .5rem 1rem; white-space: nowrap;">
                            Hide 18+/21+
                        </button>
                        <div class="btn-group" role="group">
                            <a href="#" id="orderToggleBtn" data-sort="{{ current_sort }}" data-order="{% if current_order == 'asc' %}desc{% else %}asc{% endif %}"
                                class="btn btn-light d-flex align-items-center justify-content-center order-toggle-btn flex-shrink-0"
                                style="width: 40px !important; height: 40px !important; padding: 0 !important; overflow: hidden !important;" title="Toggle Order">
                                <i class="material-icons"
                                    style="font-size: 18px;">{% if current_order == 'desc' %}arrow_downward{% else %}arrow_upward{% endif %}</i>
                            </a>
                            <button type="button" class="btn btn-light d-flex align-items-center justify-content-center flex-shrink-0" id="viewToggle" style="width: 40px !important; height: 40px !important; padding: 0 !important; overflow: hidden !important;" title="Toggle View">
                                <i class="material-icons align-middle" style="font-size: 18px;">grid_view</i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% include 'events/events_list_partial.html' %}
        </div>
    </div>
</div>

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const viewToggle = document.getElementById('viewToggle');
        const eventsGrid = document.getElementById('eventsGrid');
        const eventsList = document.getElementById('eventsList');
        const toggleIcon = viewToggle.querySelector('.material-icons');
        const toggleAdult = document.getElementById('toggleAdultEvents');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const sortButtons = document.querySelectorAll('.sort-btn');
        const orderToggleBtn = document.getElementById('orderToggleBtn');

        // Set initial state
        let isListView = localStorage.getItem('eventViewPreference') === 'list';
        let showAdult = localStorage.getItem('showAdultEvents') !== 'false'; // Default to true if not set
        let currentSort = '{{ current_sort }}';
        let currentOrder = '{{ current_order }}';

        // Function to update the UI based on events data
        function updateEventDisplay(eventsHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = eventsHtml;
            const newEventsGrid = tempDiv.querySelector('#eventsGrid');
            const newEventsList = tempDiv.querySelector('#eventsList');
            const newLoadingSpinner = tempDiv.querySelector('#loadingSpinner'); // Get the new spinner too

            if (newEventsGrid && eventsGrid) {
                eventsGrid.innerHTML = newEventsGrid.innerHTML;
            }
            if (newEventsList && eventsList) {
                eventsList.innerHTML = newEventsList.innerHTML;
            }

            // Ensure the correct view is displayed after update
            if (isListView) {
                eventsGrid.style.display = 'none';
                eventsList.style.display = 'block';
            } else {
                eventsGrid.style.display = 'flex';
                eventsList.style.display = 'none';
            }

            // Update the loading spinner in case the full response contains it
            if (newLoadingSpinner && loadingSpinner) {
                loadingSpinner.style.display = newLoadingSpinner.style.display; // Sync display state
            }
        }

        // Function to fetch and update events
        async function fetchEvents(sort, order, adult) {
            loadingSpinner.style.display = 'block'; // Show spinner
            try {
                const url = new URL(window.location.href);
                url.searchParams.set('sort', sort);
                url.searchParams.set('order', order);
                url.searchParams.set('adult', adult);

                // Update current sort and order for future interactions
                currentSort = sort;
                currentOrder = order;

                // Update URL in browser history
                history.pushState({ sort: sort, order: order, adult: adult }, '', url.toString());

                const response = await fetch(url.toString());
                const html = await response.text();
                
                // Extract the content of the event sections from the full HTML response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newEventsGridHtml = doc.querySelector('#eventsGrid').innerHTML;
                const newEventsListHtml = doc.querySelector('#eventsList').innerHTML;
                const newLoadingSpinnerHtml = doc.querySelector('#loadingSpinner').innerHTML;

                // Update the existing elements
                eventsGrid.innerHTML = newEventsGridHtml;
                eventsList.innerHTML = newEventsListHtml;
                loadingSpinner.innerHTML = newLoadingSpinnerHtml;

                // Apply current view preference after update
                if (isListView) {
                    eventsGrid.style.display = 'none';
                    eventsList.style.display = 'block';
                } else {
                    eventsGrid.style.display = 'flex';
                    eventsList.style.display = 'none';
                }

                // Update active state for sort buttons
                sortButtons.forEach(button => {
                    button.classList.remove('btn-primary', 'text-white');
                    button.classList.add('btn-outline-primary');
                    if (button.dataset.sort === currentSort) {
                        button.classList.remove('btn-outline-primary');
                        button.classList.add('btn-primary', 'text-white');
                    }
                });

                // Update the order toggle button's data-order attribute and icon
                orderToggleBtn.dataset.order = currentOrder;
                const orderIcon = orderToggleBtn.querySelector('.material-icons');
                if (orderIcon) {
                    orderIcon.textContent = currentOrder === 'desc' ? 'arrow_downward' : 'arrow_upward';
                }

            } catch (error) {
                console.error('Error fetching events:', error);
            } finally {
                loadingSpinner.style.display = 'none'; // Hide spinner
            }
        }

        // Event Listeners for Sorting Buttons
        sortButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const sortType = this.dataset.sort;
                // If clicking the currently active sort button, reverse the order
                const newOrder = (sortType === currentSort) ? (currentOrder === 'asc' ? 'desc' : 'asc') : currentOrder;
                fetchEvents(sortType, newOrder, showAdult);
            });
        });

        // Event Listener for Order Toggle Button
        orderToggleBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            currentOrder = newOrder; // Update currentOrder immediately
            this.dataset.order = newOrder; // Update dataset.order immediately
            fetchEvents(currentSort, newOrder, showAdult);
        });

        // Toggle Adult Events
        function toggleAdultEvents() {
            showAdult = !showAdult;
            localStorage.setItem('showAdultEvents', showAdult);
            if (showAdult) {
                toggleAdult.textContent = 'Hide 18+/21+';
                toggleAdult.classList.remove('btn-success');
                toggleAdult.classList.add('btn-danger');
            } else {
                toggleAdult.textContent = 'Show 18+/21+';
                toggleAdult.classList.remove('btn-danger');
                toggleAdult.classList.add('btn-success');
            }
            fetchEvents(currentSort, currentOrder, showAdult);
        }

        toggleAdult.addEventListener('click', toggleAdultEvents);

        // View Toggle (Grid/List)
        function toggleView() {
            isListView = !isListView;
            localStorage.setItem('eventViewPreference', isListView ? 'list' : 'grid');
            if (isListView) {
                eventsGrid.style.display = 'none';
                eventsList.style.display = 'block';
                toggleIcon.textContent = 'view_list';
            } else {
                eventsGrid.style.display = 'flex';
                eventsList.style.display = 'none';
                toggleIcon.textContent = 'grid_view';
            }
        }

        viewToggle.addEventListener('click', toggleView);

        // Initial display setup
        if (isListView) {
            eventsGrid.style.display = 'none';
            eventsList.style.display = 'block';
            toggleIcon.textContent = 'view_list';
        } else {
            eventsGrid.style.display = 'flex';
            eventsList.style.display = 'none';
            toggleIcon.textContent = 'grid_view';
        }

        // On page load, set the correct color
        if (showAdult) {
            toggleAdult.textContent = 'Hide 18+/21+';
            toggleAdult.classList.remove('btn-success');
            toggleAdult.classList.add('btn-danger');
        } else {
            toggleAdult.textContent = 'Show 18+/21+';
            toggleAdult.classList.remove('btn-danger');
            toggleAdult.classList.add('btn-success');
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            const state = event.state;
            if (state) {
                currentSort = state.sort || 'date';
                currentOrder = state.order || 'asc';
                showAdult = state.adult !== false; // Default to true
                fetchEvents(currentSort, currentOrder, showAdult); // Re-fetch with historical state
            } else {
                // If no state, it might be the initial page load or a navigation outside our pushState calls
                // Reload page or re-fetch with default parameters to ensure consistency
                fetchEvents('date', 'asc', true);
            }
        });
    });
</script>
{% endblock %}
{% endblock %}